
generator client {
  provider      = "prisma-client-js"
  // node:20-slim = Debian Bookworm = OpenSSL 3.0.x UNIQUEMENT
  binaryTargets = ["native", "debian-openssl-3.0.x", "debian-openssl-1.1.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum Role {
  CITOYEN           // Utilisateur authentifié (VISITEUR supprimé - accès public via pages non protégées)
  DELEGATION        // Responsable secteur : crée événements, actualités, articles, campagnes
  AUTORITE_LOCALE   // Gestionnaire commune : gère réclamations de la commune
  ADMIN             // Gestion complète : validation, affectation, CRUD total
  SUPER_ADMIN       // Gère les droits des admins + toutes permissions admin
  GOUVERNEUR        // Vue globale lecture seule + détails + téléchargement
  COORDINATEUR_ACTIVITES // Gère les programmes d'activités quotidiennes des établissements
}



enum Secteur {
  EDUCATION
  SANTE
  SPORT
  SOCIAL
  CULTUREL
  AUTRE
}

// Statut des activités programmées (pour COORDINATEUR_ACTIVITES)
enum StatutActivite {
  BROUILLON                // Brouillon - visible uniquement par le coordinateur
  EN_ATTENTE_VALIDATION    // Soumis pour validation par l'admin
  PLANIFIEE                // Activité validée et programmée pour le futur
  EN_COURS                 // Activité en cours actuellement
  TERMINEE                 // Activité terminée, rapport requis
  RAPPORT_COMPLETE         // Rapport post-activité rempli
  ANNULEE                  // Activité annulée
  REPORTEE                 // Activité reportée à une autre date
}

enum StatutReclamation {
  ACCEPTEE          // Réclamation acceptée par admin (peut être affectée)
  REJETEE           // Réclamation rejetée par admin avec motif
}

enum AffectationReclamation {
  NON_AFFECTEE      // Pas encore affectée (en attente)
  AFFECTEE          // Affectée à autorité locale ou service interne
}

enum StatutEvenement {
  EN_ATTENTE_VALIDATION    // Créé par délégation, en attente validation admin
  PUBLIEE                  // Validé et publié par admin, visible publiquement
  EN_ACTION                // Événement en cours actuellement
  CLOTUREE                 // Événement terminé avec bilan publié
  REJETEE                  // Rejeté par admin avec motif
}

enum StatutActualite {
  BROUILLON
  EN_ATTENTE_VALIDATION
  VALIDEE
  PUBLIEE
  DEPUBLIEE
  ARCHIVEE
}

enum StatutSuggestion {
  SOUMISE
  EN_EXAMEN
  APPROUVEE
  REJETEE
  IMPLEMENTEE
}

enum TypeZone {
  URBAINE
  RURALE
  PERI_URBAINE
}

enum Accessibilite {
  FACILE
  MOYENNE
  DIFFICILE
}

enum EtatInfrastructure {
  EXCELLENT
  BON
  MOYEN
  DEGRADE
  A_RENOVER
  DANGEREUX
}

enum TypeMedia {
  IMAGE
  VIDEO
  DOCUMENT
  AUDIO
  AUTRE
}

// ============================================
// GESTION DES UTILISATEURS
// ============================================

model User {
  id                      Int       @id @default(autoincrement())
  
  // Authentification
  email                   String    @unique
  telephone               String?   @unique
  motDePasse              String    // Hashé bcrypt
  
  // Identité
  nom                     String
  prenom                  String
  photo                   String?
  
  // Rôle et statut
  role                    Role      @default(CITOYEN)
  isActive                Boolean   @default(true)
  isEmailVerifie          Boolean   @default(false)
  isTelephoneVerifie      Boolean   @default(false)
  
  // Tokens pour réinitialisation et vérification
  resetToken              String?
  resetTokenExpiry        DateTime?
  emailVerificationToken  String?
  emailVerificationExpiry DateTime?
  
  // Authentification à deux facteurs (2FA)
  twoFactorSecret         String?   // Secret TOTP (chiffré)
  twoFactorEnabled        Boolean   @default(false)
  twoFactorBackupCodes    String?   // Codes de secours (JSON chiffré)

  // === SÉCURITÉ : Tracking tentatives de connexion ===
  loginAttempts           Int       @default(0)    // Nombre de tentatives échouées
  lastFailedLogin         DateTime?               // Date de dernière tentative échouée
  lockedUntil             DateTime?               // Date de fin de blocage
  
  // === PROFIL DELEGATION (Responsable Secteur) ===
  secteurResponsable      Secteur?  // Si DELEGATION : secteur géré
  
  // === PROFIL AUTORITE LOCALE (Responsable Commune) ===
  // Chaque autorité locale (ex: Pacha) gère TOUS les établissements d'une commune
  communeResponsableId    Int?      @unique
  communeResponsable      Commune?  @relation("AutoriteLocaleCommune", fields: [communeResponsableId], references: [id])
  
  // Traçabilité
  derniereConnexion       DateTime?
  dateInscription         DateTime  @default(now())
  
  // Préférences utilisateur (notifications, thème, etc.)
  preferences             Json?     @default("{}")
  
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
  
  // Relations
  evaluations             Evaluation[]
  reclamationsCreees      Reclamation[]
  suggestions             Suggestion[]
  notifications           Notification[]
  abonnements             AbonnementEtablissement[]
  
  // Contenus créés par DELEGATION
  evenementsCrees         Evenement[]
  actualiteCreees         Actualite[]
  articlesCrees           Article[]
  campagnesCreees         Campagne[]
  
  // Permissions granulaires (RBAC)
  userPermissions         UserPermission[]
  
  // Participations aux campagnes
  participationsCampagnes ParticipationCampagne[]
  
  // Logs d'activité (existant)
  activityLogs            ActivityLog[]
  
  // Logs d'audit de sécurité (nouveau - plus détaillé)
  auditLogs               AuditLog[]
  
  // Tokens de sécurité (reset password, verification, etc.)
  securityTokens          SecurityToken[]
  
  // === PROFIL COORDINATEUR ACTIVITÉS ===
  // Établissements gérés par ce coordinateur (IDs stockés directement)
  etablissementsGeres     Int[]     @default([])
  // Programmes d'activités créés par ce coordinateur
  programmesCrees         ProgrammeActivite[] @relation("ProgrammeCreateur")
  
  @@index([email])
  @@index([role])
  @@index([isActive])
  @@index([secteurResponsable])
  @@index([communeResponsableId])
  @@index([role, isActive]) // Index composite pour filtrer users actifs par rôle
}


// ============================================
// GESTION TERRITORIALE HIÉRARCHIQUE
// Province → Commune → Annexe → Établissement
// ============================================

model Commune {
  id                      Int       @id @default(autoincrement())
  
  // Identité administrative
  code                    String    @unique // Code officiel
  nom                     String
  nomArabe                String?
  
  // Hiérarchie administrative
  region                  String
  province                String    // Province de Médiouna
  
  // Données démographiques
  population              Int?
  superficieKm2           Float?
  densite                 Float?
  
  // Géolocalisation (centroïde)
  latitude                Float?
  longitude               Float?
  
  // Données SIG
  geojsonBoundary         Json?     // Polygone GeoJSON
  
  // Métadonnées
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
  
  // Relations
  annexes                 Annexe[]
  etablissements          Etablissement[]  // Relation directe gardée pour flexibilité
  reclamations            Reclamation[]
  evenements              Evenement[]
  
  // Autorité locale responsable de cette commune
  autoriteLocale          User?     @relation("AutoriteLocaleCommune")
  
  @@index([code])
  @@index([nom])
  @@index([province])
}

// ============================================
// ANNEXES ADMINISTRATIVES
// Subdivision de la commune pour découpage précis
// ============================================

model Annexe {
  id                      Int       @id @default(autoincrement())
  
  // Identité
  code                    String    @unique // Code unique annexe
  nom                     String    // Ex: "AA ABBERAR", "AA AL HAMD"
  nomArabe                String?
  
  // Rattachement commune
  communeId               Int
  commune                 Commune   @relation(fields: [communeId], references: [id])
  
  // Géolocalisation
  latitude                Float?
  longitude               Float?
  
  // Données SIG (découpage précis)
  geojsonBoundary         Json?     // Polygone GeoJSON de l'annexe
  
  // Statistiques
  population              Int?
  superficieKm2           Float?
  
  // Métadonnées
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
  
  // Relations
  etablissements          Etablissement[]
  
  @@index([communeId])
  @@index([code])
  @@index([nom])
}

// ============================================
// ÉTABLISSEMENTS UNIFIÉS
// Secteur détermine les attributs spécifiques
// Position géographique précise pour carte 3D
// ============================================

model Etablissement {
  id                      Int       @id @default(autoincrement())
  
  // === IDENTIFICATION ===
  code                    String    @unique // EDU-MED-001
  nom                     String
  nomArabe                String?
  secteur                 Secteur   // Détermine attributs spécifiques
  typeEtablissement       String?   // Type_Etab (école primaire, collège, lycée, etc.)
  
  // === DONNÉES SOURCE EXCEL ===
  codeCommune             String?   // IDEM_COMMU - Code commune source
  dateCreationFiche       DateTime? // Date de création de la fiche source
  observation             String?   // Observations/remarques du fichier source
  
  // === LOCALISATION ADMINISTRATIVE HIÉRARCHIQUE ===
  // DOUBLE RELATION (Commune obligatoire + Annexe optionnelle pour précision)
  communeId               Int       // OBLIGATOIRE
  commune                 Commune   @relation(fields: [communeId], references: [id])
  
  annexeId                Int?      // OPTIONNEL (précision supplémentaire)
  annexe                  Annexe?   @relation(fields: [annexeId], references: [id])
  
  quartierDouar           String?
  adresseComplete         String?
  
  // === GÉOLOCALISATION PRÉCISE (Obligatoire pour carte 3D) ===
  latitude                Float     // Obligatoire
  longitude               Float     // Obligatoire
  altitude                Float?
  
  // === CARACTÉRISTIQUES TERRITORIALES ===
  zoneTypologie           TypeZone?
  accessibilite           Accessibilite?
  voieAcces               String?
  distanceChefLieu        Float?
  transportPublic         String?
  
  // === INFORMATIONS ADMINISTRATIVES ===
  nature                  String?   // Public, Privé
  tutelle                 String?
  statutJuridique         String?
  gestionnaire            String?
  responsableNom          String?
  anneeCreation           Int?
  anneeOuverture          Int?
  
  // === CONTACT ===
  telephone               String?
  email                   String?
  siteWeb                 String?
  
  // === INFRASTRUCTURES ===
  etatInfrastructure      EtatInfrastructure?
  surfaceTotale           Float?
  disponibiliteEau        Boolean?
  disponibiliteElectricite Boolean?
  connexionInternet       Boolean?
  nombreSalles            Int?      // Nbre_des_Salles - Nombre de salles
  
  // === RESSOURCES HUMAINES ===
  effectifTotal           Int?
  nombrePersonnel         Int?      // Nb_de_personn - Nombre de personnel
  cadre                   String?   // Cadre - Type/catégorie du personnel
  
  // === CAPACITÉ ===
  capaciteAccueil         Int?
  
  // === STATISTIQUES PÉDAGOGIQUES (Secteur Éducation) ===
  elevesPrescolaire       Int?      // Élèves_Prescolai
  elevesTotal             Int?      // Élèves_PrescolaiTotal - Total élèves
  elevesFilles            Int?      // Nb_élèves_Filles
  nouveauxInscrits        Int?      // NV_Inscrits
  nouveauxInscritsFilles  Int?      // NV_Inscrits_Fille
  derniereAnnee           String?   // Dernier_Année - Année scolaire
  tauxReussite            Float?    // Dernier_Année_Taux_de_réussit (%)
  
  // === SERVICES ET PROGRAMMES ===
  services                String[]
  programmes              String[]
  
  // === DONNÉES SPÉCIFIQUES PAR SECTEUR (JSON) ===
  donneesSpecifiques      Json      // Structure selon secteur
  
  // === MÉDIAS (Gérés via relation Media) ===
  photoPrincipale         String?
  
  // === AFFICHAGE CARTE 3D ===
  modele3DUrl             String?   // URL modèle 3D pour carte
  couleurAffichage        String?   // Code couleur hex
  iconePersonnalise       String?   // URL icône personnalisée
  
  // === ÉVALUATION GLOBALE ===
  noteMoyenne             Float     @default(0)
  nombreEvaluations       Int       @default(0)
  
  // === VISIBILITÉ ET VALIDATION ===
  isPublie                Boolean   @default(false)
  isValide                Boolean   @default(false) // Validation admin obligatoire
  isMisEnAvant            Boolean   @default(false)
  
  // === STATUT OPÉRATIONNEL ===
  statutFonctionnel       String?   // Fonctionnel, Partiel, En rénovation
  
  // === FINANCEMENT ===
  sourcesFinancement      String?
  budgetAnnuel            Float?
  partenaires             String?
  
  // === OBSERVATIONS ===
  remarques               String?
  besoinsUrgents          String?
  projetsFuturs           String?
  
  // === MÉTADONNÉES ===
  annee                   Int       @default(2026)
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
  
  // === RELATIONS ===
  evaluations             Evaluation[]
  reclamations            Reclamation[]
  evenements              Evenement[]
  actualites              Actualite[]
  abonnements             AbonnementEtablissement[]
  medias                  Media[]
  programmesActivites     ProgrammeActivite[]
  
  @@index([code])
  @@index([secteur])
  @@index([communeId])
  @@index([annexeId])
  @@index([isPublie])
  @@index([isValide])
  @@index([nature])
  @@index([statutFonctionnel])
  @@index([latitude, longitude]) // Index spatial
}

// ============================================
// GESTION CENTRALISÉE DES MÉDIAS
// Pour événements, réclamations, établissements
// ============================================

model Media {
  id                      Int       @id @default(autoincrement())
  
  // Fichier
  nomFichier              String
  cheminFichier           String    // Chemin stockage
  urlPublique             String    // URL accessible
  type                    TypeMedia
  mimeType                String
  tailleMo                Float?
  
  // Métadonnées
  largeur                 Int?      // Pour images/vidéos
  hauteur                 Int?
  duree                   Int?      // Pour vidéos/audio (secondes)
  
  // Relations (optionnelles selon contexte)
  etablissementId         Int?
  etablissement           Etablissement? @relation(fields: [etablissementId], references: [id], onDelete: Cascade)
  
  evenementId             Int?
  evenement               Evenement? @relation(fields: [evenementId], references: [id], onDelete: Cascade)
  
  reclamationId           Int?
  reclamation             Reclamation? @relation(fields: [reclamationId], references: [id], onDelete: Cascade)
  
  actualiteId             Int?
  actualite               Actualite? @relation(fields: [actualiteId], references: [id], onDelete: Cascade)
  
  articleId               Int?
  article                 Article?  @relation(fields: [articleId], references: [id], onDelete: Cascade)
  
  campagneId              Int?
  campagne                Campagne? @relation(fields: [campagneId], references: [id], onDelete: Cascade)
  
  talentId                Int?
  talent                  Talent?   @relation(fields: [talentId], references: [id], onDelete: Cascade)
  
  // Traçabilité
  uploadePar              Int?      // User ID
  createdAt               DateTime  @default(now())
  
  @@index([etablissementId])
  @@index([evenementId])
  @@index([reclamationId])
  @@index([actualiteId])
  @@index([articleId])
  @@index([campagneId])
  @@index([type])
}

// ============================================
// ABONNEMENTS ÉTABLISSEMENTS
// Citoyens s'abonnent pour recevoir actualités/événements
// ============================================

model AbonnementEtablissement {
  id                      Int       @id @default(autoincrement())
  
  userId                  Int
  user                    User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  etablissementId         Int
  etablissement           Etablissement @relation(fields: [etablissementId], references: [id], onDelete: Cascade)
  
  notificationsActives    Boolean   @default(true)
  
  createdAt               DateTime  @default(now())
  
  @@unique([userId, etablissementId])
  @@index([userId])
  @@index([etablissementId])
}

// ============================================
// ÉVALUATIONS GLOBALES
// Citoyens évaluent établissements (note globale uniquement)
// Admin peut aussi évaluer
// ============================================

model Evaluation {
  id                      Int       @id @default(autoincrement())
  
  // Évaluateur (Citoyen ou Admin)
  userId                  Int
  user                    User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Établissement évalué
  etablissementId         Int
  etablissement           Etablissement @relation(fields: [etablissementId], references: [id], onDelete: Cascade)
  
  // Note globale unique (1-5 étoiles)
  noteGlobale             Float
  
  // Commentaire optionnel
  commentaire             String?   @db.Text
  
  // Modération
  isSignalee              Boolean   @default(false)
  motifSignalement        String?
  isValidee               Boolean   @default(true)
  
  // Délai modification (7 jours)
  dateExpiration          DateTime
  
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
  
  @@unique([userId, etablissementId])
  @@index([etablissementId])
  @@index([isSignalee])
  @@index([isValidee])
  @@index([etablissementId, isValidee]) // Index composite pour évaluations validées par établissement
  @@index([createdAt]) // Pour le tri par date
}

// ============================================
// RÉCLAMATIONS - NOUVEAU WORKFLOW
// Workflow : Citoyen → Admin (Décision : ACCEPTEE/REJETEE) → Affectation
// Statut null = En attente décision admin
// CITOYEN uniquement peut créer (pas de VISITEUR)
// ============================================

model Reclamation {
  id                      Int       @id @default(autoincrement())
  
  // === CITOYEN (VISITEUR supprimé) ===
  userId                  Int
  user                    User      @relation(fields: [userId], references: [id])
  
  // === ÉTABLISSEMENT CONCERNÉ (optionnel) ===
  etablissementId         Int?
  etablissement           Etablissement? @relation(fields: [etablissementId], references: [id])
  
  // === LOCALISATION ===
  communeId               Int
  commune                 Commune   @relation(fields: [communeId], references: [id])
  quartierDouar           String?
  adresseComplete         String?
  
  latitude                Float?
  longitude               Float?
  
  // === CONTENU ===
  categorie               String
  titre                   String
  description             String    @db.Text
  
  // === WORKFLOW SIMPLIFIÉ ===
  statut                  StatutReclamation?  // null = En attente décision, ACCEPTEE, REJETEE
  affectationReclamation  AffectationReclamation @default(NON_AFFECTEE)
  
  // === AFFECTATION PAR ADMIN (si ACCEPTEE) ===
  affecteeParAdminId      Int?      // Admin qui affecte
  affecteeAAutoriteId     Int?      // Autorité locale (User)
  secteurAffecte          Secteur?  // Secteur de responsabilité
  serviceInterneProvince  String?   // Service interne si province
  dateAffectation         DateTime?
  
  // === SUIVI ===
  dateResolution          DateTime?
  motifRejet              String?   @db.Text  // Si REJETEE
  solutionApportee        String?   @db.Text  // Si résolue
  
  // === VISIBILITÉ ===
  isArchivee              Boolean   @default(false)
  
  // === MÉTADONNÉES ===
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
  
  // === RELATIONS ===
  historique              HistoriqueReclamation[]  // GARDÉE pour traçabilité
  medias                  Media[]
  
  @@index([userId])
  @@index([etablissementId])
  @@index([communeId])
  @@index([statut])
  @@index([affectationReclamation])
  @@index([affecteeAAutoriteId])
  @@index([secteurAffecte])
  @@index([isArchivee])
  @@index([createdAt])
  @@index([statut, affectationReclamation]) // Index composite pour filtrer par statut et affectation
  @@index([communeId, createdAt]) // Index composite pour réclamations par commune triées
  @@index([affecteeAAutoriteId, createdAt]) // Index composite pour autorité locale
}

// ============================================
// HISTORIQUE RÉCLAMATIONS
// TABLE GARDÉE pour audit trail et timeline
// ============================================

model HistoriqueReclamation {
  id                      Int       @id @default(autoincrement())
  
  reclamationId           Int
  reclamation             Reclamation @relation(fields: [reclamationId], references: [id], onDelete: Cascade)
  
  action                  String    // "CREATION", "ACCEPTATION", "REJET", "AFFECTATION", "RESOLUTION"
  details                 Json?     // Données contextuelles
  effectuePar             Int       // User ID qui a fait l'action
  
  createdAt               DateTime  @default(now())
  
  @@index([reclamationId])
  @@index([createdAt])
}

// ============================================
// SUGGESTIONS CITOYENNES
// Pas de système de vote (simplifié)
// ============================================

model Suggestion {
  id                      Int       @id @default(autoincrement())
  
  userId                  Int
  user                    User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  titre                   String
  description             String    @db.Text
  categorie               String?
  
  statut                  StatutSuggestion @default(SOUMISE)
  
  // Suivi admin
  reponseAdmin            String?   @db.Text
  dateTraitement          DateTime?
  
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
  
  @@index([userId])
  @@index([statut])
  @@index([createdAt])
}

// ============================================
// ÉVÉNEMENTS - WORKFLOW 5 STATUTS
// Créés par DÉLÉGATION (responsable secteur)
// Validation admin obligatoire avant publication
// ============================================

model Evenement {
  id                      Int       @id @default(autoincrement())
  
  // === ÉTABLISSEMENT CONCERNÉ ===
  etablissementId         Int
  etablissement           Etablissement @relation(fields: [etablissementId], references: [id], onDelete: Cascade)
  
  // Secteur (hérité établissement)
  secteur                 Secteur
  
  // === LOCALISATION ===
  communeId               Int
  commune                 Commune   @relation(fields: [communeId], references: [id])
  lieu                    String?
  adresse                 String?
  quartierDouar           String?
  
  latitude                Float?
  longitude               Float?
  
  // === CONTENU ===
  // === CONTENU ===
  titre                   String
  titreAr                 String?   // Traduction Arabe
  description             String    @db.Text
  descriptionAr           String?   @db.Text // Traduction Arabe
  
  // === CATÉGORISATION ===
  typeCategorique         String
  categorie               String?
  tags                    String[]
  
  // === DATES ET HORAIRES ===
  dateDebut               DateTime
  dateFin                 DateTime?
  heureDebut              String?
  heureFin                String?
  
  // === ORGANISATEUR ===
  organisateur            String?
  contactOrganisateur     String?
  emailContact            String?
  
  // === PARTICIPATION ===
  capaciteMax             Int?
  inscriptionsOuvertes    Boolean   @default(false)
  lienInscription         String?
  nombreInscrits          Int       @default(0)
  
  // === STATUT ET WORKFLOW (5 STATUTS) ===
  statut                  StatutEvenement @default(EN_ATTENTE_VALIDATION)
  motifRejet              String?   @db.Text  // Si REJETEE
  
  isMisEnAvant            Boolean   @default(false)
  
  // === BILAN POST-ÉVÉNEMENT (si CLOTUREE) ===
  bilanDescription        String?   @db.Text
  bilanNbParticipants     Int?
  bilanDatePublication    DateTime?
  
  // === STATISTIQUES ===
  nombreVues              Int       @default(0)
  nombrePartages          Int       @default(0)
  
  // === MÉTADONNÉES ===
  createdBy               Int       // User ID (DELEGATION)
  createdByUser           User      @relation(fields: [createdBy], references: [id])
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
  
  // === RELATIONS ===
  medias                  Media[]
  
  @@index([etablissementId])
  @@index([communeId])
  @@index([secteur])
  @@index([statut])
  @@index([dateDebut])
  @@index([isMisEnAvant])
  @@index([createdBy])
}

// ============================================
// ACTUALITÉS ÉTABLISSEMENTS
// Créées par DÉLÉGATION (pas autorités locales)
// Validation admin obligatoire
// ============================================

model Actualite {
  id                      Int       @id @default(autoincrement())
  
  // === ÉTABLISSEMENT ===
  etablissementId         Int
  etablissement           Etablissement @relation(fields: [etablissementId], references: [id], onDelete: Cascade)
  
  // === CONTENU ===
  // === CONTENU ===
  titre                   String
  titreAr                 String?   // Traduction Arabe
  description             String?
  descriptionAr           String?   // Traduction Arabe
  contenu                 String    @db.Text
  contenuAr               String?   @db.Text // Traduction Arabe
  
  // === CATÉGORISATION ===
  categorie               String?
  tags                    String[]
  
  // === PUBLICATION ===
  statut                  StatutActualite @default(BROUILLON)
  isPublie                Boolean   @default(false)
  isValide                Boolean   @default(false) // Validation admin obligatoire
  datePublication         DateTime?
  
  // === STATISTIQUES ===
  nombreVues              Int       @default(0)
  
  // === MÉTADONNÉES ===
  createdBy               Int       // User ID (DELEGATION)
  createdByUser           User      @relation(fields: [createdBy], references: [id])
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
  
  // === RELATIONS ===
  medias                  Media[]
  
  @@index([etablissementId])
  @@index([statut])
  @@index([isPublie])
  @@index([isValide])
  @@index([datePublication])
  @@index([createdBy])
}

// ============================================
// CONTENUS MÉDIOUNA ACTION
// Créés par DÉLÉGATION (pas Admin)
// ============================================

model Article {
  id                      Int       @id @default(autoincrement())
  
  titre                   String
  description             String?
  contenu                 String    @db.Text
  categorie               String?
  tags                    String[]
  
  imagePrincipale         String?
  
  isPublie                Boolean   @default(false)
  isMisEnAvant            Boolean   @default(false)
  datePublication         DateTime?
  
  nombreVues              Int       @default(0)
  
  // === MÉTADONNÉES ===
  createdBy               Int       // User ID (DELEGATION)
  createdByUser           User      @relation(fields: [createdBy], references: [id])
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
  
  // === RELATIONS ===
  medias                  Media[]
  
  @@index([isPublie])
  @@index([datePublication])
  @@index([createdBy])
}

model Video {
  id                      Int       @id @default(autoincrement())
  
  titre                   String
  description             String?   @db.Text
  urlYoutube              String
  thumbnail               String?
  
  categorie               String?
  tags                    String[]
  
  isPublie                Boolean   @default(false)
  isMisEnAvant            Boolean   @default(false)
  
  nombreVues              Int       @default(0)
  
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
  
  @@index([isPublie])
  @@index([categorie])
}

// ============================================
// TALENTS LOCAUX
// Affichage simple pour citoyens
// Pas de commentaires, pas de partage
// ============================================

model Talent {
  id                      Int       @id @default(autoincrement())
  
  nom                     String
  prenom                  String
  nomArtistique           String?
  bio                     String?   @db.Text
  domaine                 String
  
  photo                   String?
  reseauxSociaux          Json?
  
  isPublie                Boolean   @default(false)
  isMisEnAvant            Boolean   @default(false)
  
  nombreVues              Int       @default(0)
  
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
  
  // Relations
  medias                  Media[]
  
  @@index([domaine])
  @@index([isPublie])
}









// ============================================
// CAMPAGNES CITOYENNES
// Créées par DÉLÉGATION
// ============================================

model Campagne {
  id                      Int       @id @default(autoincrement())
  
  nom                     String
  slug                    String    @unique
  titre                   String
  description             String?   @db.Text
  contenu                 String    @db.Text
  
  type                    String    // "Je suis Médiouna", "Bouge Médiouna"
  
  imagePrincipale         String?
  imageCouverture         String?
  couleurTheme            String?   @default("#1e40af")
  
  nombreVues              Int       @default(0)
  
  isActive                Boolean   @default(false)
  isFeatured              Boolean   @default(false)
  
  objectifParticipations  Int?
  
  dateDebut               DateTime?
  dateFin                 DateTime?

  // Validation Workflow
  statut                  String    @default("BROUILLON") // BROUILLON, EN_ATTENTE, ACTIVE, TERMINEE, ANNULEE

  // Closure & Report
  rapportClotureUrl       String?
  bilanDescription        String?   @db.Text
  bilanChiffresCles       Json?     // Flexible JSON for custom metrics
  
  // === MÉTADONNÉES ===
  createdBy               Int       // User ID (DELEGATION)
  createdByUser           User      @relation(fields: [createdBy], references: [id])
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
  
  // === RELATIONS ===
  medias                  Media[]
  participations          ParticipationCampagne[]
  
  @@index([slug])
  @@index([isActive])
  @@index([isFeatured])
  @@index([createdBy])
}

// ============================================
// PARTICIPATIONS CAMPAGNE
// ============================================

model ParticipationCampagne {
  id                      Int       @id @default(autoincrement())
  
  campagneId              Int
  campagne                Campagne  @relation(fields: [campagneId], references: [id], onDelete: Cascade)
  
  userId                  Int
  user                    User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  message                 String?   @db.Text
  donneesParticipation    Json?
  
  createdAt               DateTime  @default(now())
  
  @@unique([campagneId, userId])
  @@index([campagneId])
  @@index([userId])
}

// ============================================
// NOTIFICATIONS
// ============================================

model Notification {
  id                      Int       @id @default(autoincrement())
  
  userId                  Int
  user                    User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type                    String
  titre                   String
  message                 String    @db.Text
  lien                    String?
  
  isLue                   Boolean   @default(false)
  
  createdAt               DateTime  @default(now())
  
  @@index([userId, isLue])
  @@index([createdAt])
}

// ============================================
// LOGS D'ACTIVITÉ
// ============================================

model ActivityLog {
  id                      Int       @id @default(autoincrement())
  
  userId                  Int?
  user                    User?     @relation(fields: [userId], references: [id], onDelete: SetNull)
  action                  String
  entity                  String
  entityId                Int?
  details                 Json?
  
  ipAddress               String?
  userAgent               String?
  
  createdAt               DateTime  @default(now())
  
  @@index([userId])
  @@index([entity])
  @@index([createdAt])
}
// ============================================
// SYSTÈME DE PERMISSIONS GRANULAIRES (RBAC)
// ============================================

model Permission {
  id                      Int       @id @default(autoincrement())
  
  // Identifiant unique de la permission
  code                    String    @unique // Ex: "users.read", "reclamations.validate"
  
  // Informations descriptives
  nom                     String    // Ex: "Voir les utilisateurs"
  description             String?   // Description détaillée
  
  // Catégorisation
  groupe                  String    // Ex: "users", "reclamations", "evenements"
  groupeLabel             String    // Ex: "Utilisateurs", "Réclamations"
  
  // Métadonnées
  ordre                   Int       @default(0)  // Ordre d affichage
  isActive                Boolean   @default(true)
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
  
  // Relations
  userPermissions         UserPermission[]
  
  @@index([groupe])
  @@index([isActive])
}

model UserPermission {
  id                      Int       @id @default(autoincrement())
  
  // Utilisateur concerné
  userId                  Int
  user                    User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Permission accordée
  permissionId            Int
  permission              Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  
  // Qui a accordé cette permission
  grantedById             Int?
  
  // Métadonnées
  grantedAt               DateTime  @default(now())
  expiresAt               DateTime? // Permission temporaire
  isActive                Boolean   @default(true)
  
  @@unique([userId, permissionId])
  @@index([userId])
  @@index([permissionId])
  @@index([isActive])
}

// ============================================
// SYSTEM SETTINGS (Paramètres Système)
// ============================================

model SystemSetting {
  id                    Int       @id @default(autoincrement())
  key                   String    @unique // Clé unique du paramètre
  value                 Json      // Valeur en JSON pour flexibilité
  category              String    // Catégorie: general, security, notifications, reclamations
  description           String?   // Description du paramètre
  
  // Traçabilité
  updatedById           Int?      // Qui a modifié en dernier
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  
  @@index([category])
  @@index([key])
}

// ============================================
// PROGRAMME D'ACTIVITÉS (pour COORDINATEUR_ACTIVITES)
// Gestion des activités quotidiennes des établissements
// ============================================

model ProgrammeActivite {
  id                      Int       @id @default(autoincrement())
  
  // === ÉTABLISSEMENT CONCERNÉ ===
  etablissementId         Int
  etablissement           Etablissement @relation(fields: [etablissementId], references: [id], onDelete: Cascade)
  
  // === DATE ET PÉRIODE ===
  date                    DateTime  @db.Date
  heureDebut              String    // Format "08:00"
  heureFin                String    // Format "12:00"
  
  // === DÉTAILS DE L'ACTIVITÉ ===
  titre                   String    @db.VarChar(150)
  description             String?   @db.Text
  typeActivite            String    // Cours, Réunion, Formation, Atelier, Match, etc.
  responsableNom          String?   // Personne responsable de l'activité
  participantsAttendus    Int?      // Nombre de participants prévus
  lieu                    String?   // Salle 3, Terrain de foot, Cour intérieure...
  
  // === STATUT DE L'ACTIVITÉ ===
  statut                  StatutActivite @default(BROUILLON)
  
  // === RAPPORT POST-ACTIVITÉ (visible Admin/Gouverneur uniquement) ===
  presenceEffective       Int?      // Nombre réel de participants
  tauxPresence            Float?    // Auto-calculé: presenceEffective / participantsAttendus * 100
  commentaireDeroulement  String?   @db.Text
  difficultes             String?   @db.Text
  pointsPositifs          String?   @db.Text
  photosRapport           String[]  // URLs des photos du rapport
  noteQualite             Float?    // Note de 1 à 5
  recommandations         String?   @db.Text
  rapportComplete         Boolean   @default(false)
  dateRapport             DateTime?
  
  // === VISIBILITÉ ET VALIDATION ===
  isVisiblePublic         Boolean   @default(true)  // Visible dans le calendrier public
  isValideParAdmin        Boolean   @default(false) // Validation requise par admin (configurable)
  requireValidation       Boolean   @default(true)  // Cette activité nécessite-t-elle validation?
  
  // === RÉCURRENCE (V1) ===
  isRecurrent             Boolean   @default(false)
  recurrencePattern       String?   // DAILY, WEEKLY, MONTHLY
  recurrenceEndDate       DateTime? @db.Date
  recurrenceDays          Int[]     // Jours spécifiques pour WEEKLY (0=Dimanche, 1=Lundi...)
  recurrenceParentId      Int?      // ID de l'activité parente si générée par récurrence
  
  // === NOTIFICATIONS ===
  rappelJ1Envoye          Boolean   @default(false) // Rappel J-1 envoyé
  alerteRapportEnvoyee    Boolean   @default(false) // Alerte rapport requis envoyée
  
  // === MÉTADONNÉES ===
  createdBy               Int
  createdByUser           User      @relation("ProgrammeCreateur", fields: [createdBy], references: [id])
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
  
  @@index([etablissementId, date])
  @@index([statut])
  @@index([createdBy])
  @@index([date])
  @@index([isVisiblePublic, isValideParAdmin])

}

// ============================================
// AUDIT LOG - TRAÇABILITÉ DE SÉCURITÉ
// ============================================

model AuditLog {
  id                      Int       @id @default(autoincrement())
  
  // === ACTION ===
  action                  String    // LOGIN, LOGOUT, ACCESS_DENIED, CREATE, UPDATE, DELETE, etc.
  resourceType            String?   // User, Reclamation, Etablissement, etc.
  resourceId              String?   // ID de la ressource affectée
  
  // === ACTEUR ===
  userId                  Int?      // Null si action anonyme (ex: tentative de login échouée)
  user                    User?     @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  // === DÉTAILS ===
  details                 String?   @db.Text // JSON avec les détails de l'action
  previousValue           String?   @db.Text // Ancienne valeur (pour UPDATE)
  newValue                String?   @db.Text // Nouvelle valeur (pour UPDATE)
  
  // === CONTEXTE TECHNIQUE ===
  ipAddress               String?   // Adresse IP du client
  userAgent               String?   // User-Agent du navigateur
  requestId               String?   // ID unique de la requête
  
  // === RÉSULTAT ===
  success                 Boolean   @default(true)
  errorMessage            String?   // Message d'erreur si échec
  
  // === MÉTADONNÉES ===
  createdAt               DateTime  @default(now())
  
  @@index([action])
  @@index([userId])
  @@index([resourceType, resourceId])
  @@index([createdAt])
  @@index([ipAddress])
  @@index([success])
}

// ============================================
// SECURITY TOKENS - Tokens de Sécurité
// ============================================

model SecurityToken {
  id                      Int       @id @default(autoincrement())
  
  // === TOKEN ===
  token                   String    @unique
  type                    String    // PASSWORD_RESET, EMAIL_VERIFICATION, API_KEY
  
  // === UTILISATEUR ===
  userId                  Int
  user                    User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // === VALIDITÉ ===
  expiresAt               DateTime
  usedAt                  DateTime?
  isRevoked               Boolean   @default(false)
  
  // === MÉTADONNÉES ===
  createdAt               DateTime  @default(now())
  ipAddress               String?   // IP lors de la création
  
  @@index([token])
  @@index([userId])
  @@index([type])
  @@index([expiresAt])
}





