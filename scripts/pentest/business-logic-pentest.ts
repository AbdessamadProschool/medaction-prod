/**
 * ğŸ”´ MEDACTION - BUSINESS LOGIC & DOS PENTEST
 * Tests: Rate Limiting, Business Logic Flaws, Resource Exhaustion
 * 
 * Run: npx tsx business-logic-pentest.ts
 */

const BASE_URL = 'http://localhost:3000';
const C = { r: '\x1b[0m', b: '\x1b[1m', red: '\x1b[31m', grn: '\x1b[32m', yel: '\x1b[33m', cyn: '\x1b[36m', mag: '\x1b[35m' };

interface Result { test: string; pass: boolean; sev: string; detail: string; }
const results: Result[] = [];

async function http(url: string, opt: RequestInit = {}): Promise<{ st: number; txt: string; tm: number; json: any }> {
  const s = Date.now();
  try {
    const r = await fetch(`${BASE_URL}${url}`, { ...opt, headers: { 'Content-Type': 'application/json', ...(opt.headers as any || {}) }});
    const txt = await r.text();
    let json = null; try { json = JSON.parse(txt); } catch {}
    return { st: r.status, txt, tm: Date.now() - s, json };
  } catch { return { st: 0, txt: '', tm: Date.now() - s, json: null }; }
}

function log(pass: boolean, test: string, detail: string, sev = 'INFO') {
  const icon = pass ? `${C.grn}âœ“${C.r}` : `${C.red}âœ—${C.r}`;
  console.log(`  ${icon} [${sev}] ${test}`);
  if (!pass) console.log(`    ${C.yel}â†’ ${detail}${C.r}`);
  results.push({ test, pass, sev, detail });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 1. RATE LIMITING TESTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function testRateLimiting() {
  console.log(`\n${C.b}${C.mag}${'â•'.repeat(60)}${C.r}`);
  console.log(`${C.b}${C.mag}  [1] RATE LIMITING TESTS${C.r}`);
  console.log(`${C.b}${C.mag}${'â•'.repeat(60)}${C.r}\n`);

  // 1.1 Login Rate Limit
  console.log(`${C.cyn}  [1.1] Login Rate Limiting${C.r}`);
  let loginBlocked = false;
  for (let i = 0; i < 15; i++) {
    const r = await http('/api/auth/login-check', { method: 'POST' });
    if (r.st === 429 || r.json?.blocked) { loginBlocked = true; break; }
    await http('/api/auth/login-record', { method: 'POST', body: JSON.stringify({ success: false }) });
  }
  log(loginBlocked, 'Login rate limit (10 attempts)', loginBlocked ? 'Blocked correctly' : 'No blocking!', loginBlocked ? 'INFO' : 'HIGH');

  // 1.2 Registration Rate Limit
  console.log(`${C.cyn}  [1.2] Registration Rate Limiting${C.r}`);
  let regBlocked = false;
  for (let i = 0; i < 8; i++) {
    const r = await http('/api/auth/register', {
      method: 'POST',
      body: JSON.stringify({ email: `ratelimit${Date.now()}${i}@test.com`, password: 'Test123!@#', nom: 'Test', prenom: 'User' })
    });
    if (r.st === 429) { regBlocked = true; break; }
    await new Promise(r => setTimeout(r, 100));
  }
  log(regBlocked, 'Registration rate limit (5/hour)', regBlocked ? 'Blocked correctly' : '8+ registrations allowed', regBlocked ? 'INFO' : 'MEDIUM');

  // 1.3 Password Reset Rate Limit
  console.log(`${C.cyn}  [1.3] Password Reset Rate Limiting${C.r}`);
  let resetBlocked = false;
  for (let i = 0; i < 5; i++) {
    const r = await http('/api/auth/forgot-password', {
      method: 'POST',
      body: JSON.stringify({ email: `reset${i}@test.com` })
    });
    if (r.st === 429) { resetBlocked = true; break; }
  }
  log(resetBlocked, 'Password reset rate limit (3/hour)', resetBlocked ? 'Blocked correctly' : '5+ resets allowed', resetBlocked ? 'INFO' : 'MEDIUM');

  // 1.4 API Endpoint Rate Limit
  console.log(`${C.cyn}  [1.4] API Endpoint Protection${C.r}`);
  let apiBlocked = false;
  for (let i = 0; i < 100; i++) {
    const r = await http('/api/etablissements?page=1&limit=10');
    if (r.st === 429) { apiBlocked = true; break; }
  }
  log(true, 'Public API rate limit', apiBlocked ? 'Blocked after rapid requests' : 'No strict limit (OK for public)', 'INFO');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 2. BUSINESS LOGIC FLAWS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function testBusinessLogic() {
  console.log(`\n${C.b}${C.mag}${'â•'.repeat(60)}${C.r}`);
  console.log(`${C.b}${C.mag}  [2] BUSINESS LOGIC TESTS${C.r}`);
  console.log(`${C.b}${C.mag}${'â•'.repeat(60)}${C.r}\n`);

  // 2.1 Negative ID Test
  console.log(`${C.cyn}  [2.1] Negative ID Handling${C.r}`);
  const negId = await http('/api/etablissements/-1');
  log(negId.st === 404 || negId.st === 400, 'Negative ID rejected', `Status: ${negId.st}`, negId.st === 500 ? 'MEDIUM' : 'INFO');

  // 2.2 Zero ID Test
  const zeroId = await http('/api/etablissements/0');
  log(zeroId.st === 404 || zeroId.st === 400, 'Zero ID rejected', `Status: ${zeroId.st}`, zeroId.st === 500 ? 'MEDIUM' : 'INFO');

  // 2.3 Very Large ID Test
  const largeId = await http('/api/etablissements/99999999999999');
  log(largeId.st === 404 || largeId.st === 400, 'Large ID handled', `Status: ${largeId.st}`, largeId.st === 500 ? 'MEDIUM' : 'INFO');

  // 2.4 Float ID Test
  const floatId = await http('/api/etablissements/1.5');
  log(floatId.st !== 500, 'Float ID handled', `Status: ${floatId.st}`, floatId.st === 500 ? 'MEDIUM' : 'INFO');

  // 2.5 String ID Test
  const stringId = await http('/api/etablissements/abc');
  log(stringId.st === 404 || stringId.st === 400, 'String ID rejected', `Status: ${stringId.st}`, stringId.st === 500 ? 'MEDIUM' : 'INFO');

  // 2.6 Role Escalation via Registration
  console.log(`${C.cyn}  [2.2] Role Escalation Prevention${C.r}`);
  const roleEsc = await http('/api/auth/register', {
    method: 'POST',
    body: JSON.stringify({ email: `role${Date.now()}@test.com`, password: 'Test123!@#', nom: 'Test', prenom: 'User', role: 'SUPER_ADMIN' })
  });
  const userRole = roleEsc.json?.data?.user?.role;
  log(userRole !== 'SUPER_ADMIN', 'Role injection blocked', `Created with role: ${userRole || 'CITOYEN'}`, userRole === 'SUPER_ADMIN' ? 'CRITICAL' : 'INFO');

  // 2.7 Mass Assignment
  console.log(`${C.cyn}  [2.3] Mass Assignment Protection${C.r}`);
  const massAssign = await http('/api/auth/register', {
    method: 'POST',
    body: JSON.stringify({ 
      email: `mass${Date.now()}@test.com`, password: 'Test123!@#', nom: 'Test', prenom: 'User',
      isActive: true, isEmailVerifie: true, isSuperAdmin: true
    })
  });
  log(massAssign.st === 400 || !massAssign.json?.data?.user?.isSuperAdmin, 'Mass assignment blocked', 'Extra fields ignored', 'INFO');

  // 2.8 Pagination Abuse
  console.log(`${C.cyn}  [2.4] Pagination Limits${C.r}`);
  const bigPage = await http('/api/etablissements?page=1&limit=10000');
  const dataLen = bigPage.json?.data?.length || 0;
  log(dataLen <= 100, 'Pagination limit enforced', `Returned ${dataLen} items (max should be ~100)`, dataLen > 1000 ? 'MEDIUM' : 'INFO');

  // 2.9 Negative Pagination
  const negPage = await http('/api/etablissements?page=-1&limit=-10');
  log(negPage.st !== 500, 'Negative pagination handled', `Status: ${negPage.st}`, negPage.st === 500 ? 'MEDIUM' : 'INFO');

  // 2.10 Date Manipulation
  console.log(`${C.cyn}  [2.5] Date Manipulation${C.r}`);
  const futureDate = await http('/api/evenements?dateDebut=3000-01-01');
  log(futureDate.st !== 500, 'Future date handled', `Status: ${futureDate.st}`, 'INFO');

  const invalidDate = await http('/api/evenements?dateDebut=not-a-date');
  log(invalidDate.st !== 500, 'Invalid date handled', `Status: ${invalidDate.st}`, invalidDate.st === 500 ? 'MEDIUM' : 'INFO');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 3. RESOURCE EXHAUSTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function testResourceExhaustion() {
  console.log(`\n${C.b}${C.mag}${'â•'.repeat(60)}${C.r}`);
  console.log(`${C.b}${C.mag}  [3] RESOURCE EXHAUSTION TESTS${C.r}`);
  console.log(`${C.b}${C.mag}${'â•'.repeat(60)}${C.r}\n`);

  // 3.1 Large Search Query
  console.log(`${C.cyn}  [3.1] Large Input Handling${C.r}`);
  const bigSearch = 'A'.repeat(10000);
  const largeQuery = await http(`/api/search?q=${encodeURIComponent(bigSearch)}`);
  log(largeQuery.st !== 500 && largeQuery.tm < 5000, 'Large search query', `Status: ${largeQuery.st}, Time: ${largeQuery.tm}ms`, largeQuery.tm > 5000 ? 'MEDIUM' : 'INFO');

  // 3.2 Deep JSON Nesting
  console.log(`${C.cyn}  [3.2] Deep JSON Nesting${C.r}`);
  let deepJson: any = { value: 'test' };
  for (let i = 0; i < 100; i++) deepJson = { nested: deepJson };
  const deepRes = await http('/api/reclamations', {
    method: 'POST',
    body: JSON.stringify({ sujet: 'Test', description: JSON.stringify(deepJson), categorieId: 1 })
  });
  log(deepRes.st !== 500 && deepRes.tm < 5000, 'Deep JSON nesting', `Status: ${deepRes.st}, Time: ${deepRes.tm}ms`, deepRes.tm > 5000 ? 'MEDIUM' : 'INFO');

  // 3.3 Many Parameters
  console.log(`${C.cyn}  [3.3] Many Parameters${C.r}`);
  const manyParams = Array.from({ length: 1000 }, (_, i) => `param${i}=value${i}`).join('&');
  const manyRes = await http(`/api/etablissements?${manyParams}`);
  log(manyRes.st !== 500 && manyRes.tm < 5000, 'Many parameters', `Status: ${manyRes.st}, Time: ${manyRes.tm}ms`, manyRes.tm > 5000 ? 'MEDIUM' : 'INFO');

  // 3.4 Unicode Stress
  console.log(`${C.cyn}  [3.4] Unicode Stress Test${C.r}`);
  const unicode = 'ğŸ”¥'.repeat(1000) + 'ä¸­æ–‡'.repeat(500) + 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©'.repeat(500);
  const unicodeRes = await http(`/api/search?q=${encodeURIComponent(unicode)}`);
  log(unicodeRes.st !== 500, 'Unicode handling', `Status: ${unicodeRes.st}`, unicodeRes.st === 500 ? 'MEDIUM' : 'INFO');

  // 3.5 Concurrent Requests
  console.log(`${C.cyn}  [3.5] Concurrent Requests${C.r}`);
  const startTime = Date.now();
  const concurrent = await Promise.all(
    Array.from({ length: 50 }, () => http('/api/etablissements?page=1&limit=10'))
  );
  const avgTime = (Date.now() - startTime) / 50;
  const allSuccess = concurrent.every(r => r.st === 200);
  log(allSuccess && avgTime < 1000, 'Concurrent requests', `50 requests, avg: ${avgTime.toFixed(0)}ms`, avgTime > 2000 ? 'MEDIUM' : 'INFO');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 4. DATA VALIDATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function testDataValidation() {
  console.log(`\n${C.b}${C.mag}${'â•'.repeat(60)}${C.r}`);
  console.log(`${C.b}${C.mag}  [4] DATA VALIDATION TESTS${C.r}`);
  console.log(`${C.b}${C.mag}${'â•'.repeat(60)}${C.r}\n`);

  // 4.1 Email Validation
  console.log(`${C.cyn}  [4.1] Email Validation${C.r}`);
  const badEmails = ['notanemail', 'test@', '@test.com', 'test@.com', 'test..test@test.com'];
  for (const email of badEmails) {
    const r = await http('/api/auth/register', {
      method: 'POST',
      body: JSON.stringify({ email, password: 'Test123!@#', nom: 'Test', prenom: 'User' })
    });
    log(r.st === 400, `Reject invalid email: ${email}`, `Status: ${r.st}`, r.st !== 400 ? 'MEDIUM' : 'INFO');
  }

  // 4.2 Password Validation
  console.log(`${C.cyn}  [4.2] Password Validation${C.r}`);
  const weakPasswords = ['123456', 'password', 'short', 'nouppercase1!', 'NOLOWER1!', 'NoNumber!', 'NoSpecial1'];
  for (const pwd of weakPasswords) {
    const r = await http('/api/auth/register', {
      method: 'POST',
      body: JSON.stringify({ email: `pwd${Date.now()}@test.com`, password: pwd, nom: 'Test', prenom: 'User' })
    });
    log(r.st === 400, `Reject weak password: ${pwd}`, `Status: ${r.st}`, r.st !== 400 ? 'HIGH' : 'INFO');
  }

  // 4.3 Required Fields
  console.log(`${C.cyn}  [4.3] Required Fields${C.r}`);
  const missingFields = await http('/api/auth/register', {
    method: 'POST',
    body: JSON.stringify({ email: 'test@test.com' }) // Missing password, nom, prenom
  });
  log(missingFields.st === 400, 'Require all fields', `Status: ${missingFields.st}`, missingFields.st !== 400 ? 'MEDIUM' : 'INFO');

  // 4.4 Empty Body
  console.log(`${C.cyn}  [4.4] Empty Body Handling${C.r}`);
  const emptyBody = await http('/api/auth/register', { method: 'POST', body: '{}' });
  log(emptyBody.st === 400, 'Reject empty body', `Status: ${emptyBody.st}`, emptyBody.st === 500 ? 'MEDIUM' : 'INFO');

  // 4.5 Null Values
  const nullBody = await http('/api/auth/register', {
    method: 'POST',
    body: JSON.stringify({ email: null, password: null, nom: null, prenom: null })
  });
  log(nullBody.st === 400, 'Reject null values', `Status: ${nullBody.st}`, nullBody.st === 500 ? 'MEDIUM' : 'INFO');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 5. AUTHORIZATION BYPASS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function testAuthorizationBypass() {
  console.log(`\n${C.b}${C.mag}${'â•'.repeat(60)}${C.r}`);
  console.log(`${C.b}${C.mag}  [5] AUTHORIZATION BYPASS TESTS${C.r}`);
  console.log(`${C.b}${C.mag}${'â•'.repeat(60)}${C.r}\n`);

  // 5.1 Admin Endpoints Without Auth
  console.log(`${C.cyn}  [5.1] Admin Endpoints Protection${C.r}`);
  const adminEndpoints = [
    '/api/admin/users', '/api/admin/stats', '/api/admin/logs',
    '/api/admin/settings', '/api/admin/notifications'
  ];
  for (const ep of adminEndpoints) {
    const r = await http(ep);
    log(r.st === 401 || r.st === 403, `${ep} protected`, `Status: ${r.st}`, r.st === 200 ? 'CRITICAL' : 'INFO');
  }

  // 5.2 User Actions Without Auth
  console.log(`${C.cyn}  [5.2] User Actions Protection${C.r}`);
  const userActions = [
    { m: 'PATCH', p: '/api/users/1', body: { nom: 'Hacked' } },
    { m: 'DELETE', p: '/api/users/1' },
    { m: 'PATCH', p: '/api/reclamations/1', body: { statut: 'RESOLUE' } },
    { m: 'DELETE', p: '/api/evenements/1' },
  ];
  for (const action of userActions) {
    const r = await http(action.p, { method: action.m, body: JSON.stringify(action.body || {}) });
    log(r.st === 401 || r.st === 403, `${action.m} ${action.p} protected`, `Status: ${r.st}`, r.st === 200 ? 'CRITICAL' : 'INFO');
  }

  // 5.3 HTTP Method Override
  console.log(`${C.cyn}  [5.3] HTTP Method Override${C.r}`);
  const methodOverride = await http('/api/users/1', {
    method: 'POST',
    headers: { 'X-HTTP-Method-Override': 'DELETE' }
  });
  log(methodOverride.st !== 200, 'Method override blocked', `Status: ${methodOverride.st}`, methodOverride.st === 200 ? 'HIGH' : 'INFO');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAIN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function main() {
  console.log(`\n${C.b}${C.mag}${'â•'.repeat(60)}${C.r}`);
  console.log(`${C.b}${C.mag}  ğŸ”´ BUSINESS LOGIC & DOS PENTEST${C.r}`);
  console.log(`${C.b}${C.mag}${'â•'.repeat(60)}${C.r}\n`);

  const health = await http('/api/health');
  if (health.st === 0) { console.log(`${C.red}Server not running${C.r}`); process.exit(1); }
  console.log(`${C.grn}âœ“ Server ready${C.r}`);

  await testRateLimiting();
  await testBusinessLogic();
  await testResourceExhaustion();
  await testDataValidation();
  await testAuthorizationBypass();

  // FINAL REPORT
  const passed = results.filter(r => r.pass).length;
  const failed = results.filter(r => !r.pass).length;
  const critical = results.filter(r => !r.pass && r.sev === 'CRITICAL').length;
  const high = results.filter(r => !r.pass && r.sev === 'HIGH').length;

  console.log(`\n${C.b}${C.mag}${'â•'.repeat(60)}${C.r}`);
  console.log(`${C.b}${C.mag}  FINAL REPORT${C.r}`);
  console.log(`${C.b}${C.mag}${'â•'.repeat(60)}${C.r}`);
  console.log(`  Total: ${results.length} | Passed: ${passed} | Failed: ${failed}`);
  console.log(`  CRITICAL: ${critical} | HIGH: ${high}`);
  
  if (critical === 0 && high === 0) {
    console.log(`\n${C.b}${C.grn}  âœ… ALL CRITICAL TESTS PASSED${C.r}\n`);
  } else {
    console.log(`\n${C.b}${C.red}  âš ï¸ ISSUES FOUND - REVIEW REQUIRED${C.r}\n`);
  }
}

main().catch(console.error);
