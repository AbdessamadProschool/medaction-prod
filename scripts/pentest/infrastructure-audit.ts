/**
 * ╔══════════════════════════════════════════════════════════════════════════════════════════════════╗
 * ║                 MEDACTION - INFRASTRUCTURE SECURITY AUDIT SUITE                                  ║
 * ║                  DevSecOps Automated Security Assessment                                         ║
 * ╠══════════════════════════════════════════════════════════════════════════════════════════════════╣
 * ║  Standards: OWASP | NIST 800-53 | CIS Benchmarks | ISO 27001                                    ║
 * ╚══════════════════════════════════════════════════════════════════════════════════════════════════╝
 * 
 * Run: npx tsx infrastructure-audit.ts
 */

import { readFileSync, existsSync, readdirSync, statSync } from 'fs';
import { join } from 'path';
import { execSync } from 'child_process';

const C = { r: '\x1b[0m', b: '\x1b[1m', red: '\x1b[31m', grn: '\x1b[32m', yel: '\x1b[33m', mag: '\x1b[35m', cyn: '\x1b[36m', dim: '\x1b[2m' };

interface AuditResult {
  category: string;
  check: string;
  status: 'PASS' | 'FAIL' | 'WARN' | 'INFO';
  severity: 'CRITICAL' | 'HIGH' | 'MEDIUM' | 'LOW' | 'INFO';
  details: string;
  recommendation?: string;
}

const results: AuditResult[] = [];

function log(r: AuditResult) {
  const icons = { PASS: `${C.grn}✓${C.r}`, FAIL: `${C.red}✗${C.r}`, WARN: `${C.yel}⚠${C.r}`, INFO: `${C.cyn}ℹ${C.r}` };
  console.log(`  ${icons[r.status]} [${r.severity}] ${r.check}`);
  if (r.status === 'FAIL' || r.status === 'WARN') {
    console.log(`    ${C.dim}→ ${r.details}${C.r}`);
    if (r.recommendation) console.log(`    ${C.cyn}Fix: ${r.recommendation}${C.r}`);
  }
  results.push(r);
}

function section(title: string) {
  console.log(`\n${C.mag}${'═'.repeat(70)}${C.r}`);
  console.log(`${C.b}${C.mag}  ${title}${C.r}`);
  console.log(`${C.mag}${'═'.repeat(70)}${C.r}\n`);
}

function readFile(path: string): string | null {
  try { return readFileSync(path, 'utf8'); } catch { return null; }
}

function fileExists(path: string): boolean {
  return existsSync(path);
}

function runCommand(cmd: string): string {
  try { return execSync(cmd, { encoding: 'utf8', timeout: 30000 }); } catch { return ''; }
}

// ═══════════════════════════════════════════════════════════════════════════
// 1. SECRETS DETECTION
// ═══════════════════════════════════════════════════════════════════════════
function auditSecrets() {
  section('1. SECRETS & SENSITIVE DATA');
  
  // Check .gitignore
  const gitignore = readFile('.gitignore') || '';
  log({
    category: 'SECRETS', check: '.env in .gitignore',
    status: gitignore.includes('.env') ? 'PASS' : 'FAIL',
    severity: 'CRITICAL',
    details: gitignore.includes('.env') ? 'env files excluded' : '.env NOT in .gitignore!',
    recommendation: 'Add .env and .env*.local to .gitignore'
  });

  // Check .env.example for secrets
  const envExample = readFile('.env.example') || '';
  const secretPatterns = [/[A-Za-z0-9+/]{32,}=*/g, /sk_live_[a-zA-Z0-9]+/, /password\s*=\s*"[^"]+"/i];
  let hasSecrets = false;
  for (const pattern of secretPatterns) {
    if (pattern.test(envExample) && !envExample.includes('generate-with')) hasSecrets = true;
  }
  log({
    category: 'SECRETS', check: '.env.example contains no real secrets',
    status: hasSecrets ? 'FAIL' : 'PASS',
    severity: 'CRITICAL',
    details: hasSecrets ? 'Real secrets found in .env.example!' : 'Only placeholders found',
    recommendation: 'Replace real values with placeholders like YOUR_SECRET_HERE'
  });

  // Check for hardcoded secrets in code
  const dangerousPatterns = ['password=', 'apikey=', 'secret=', 'token='];
  let hardcodedSecrets = 0;
  const srcFiles = ['lib/', 'app/', 'components/'];
  // Simplified check - in production use gitleaks
  log({
    category: 'SECRETS', check: 'No hardcoded secrets in source',
    status: 'INFO', severity: 'HIGH',
    details: 'Run: npx gitleaks detect --source . -v',
    recommendation: 'Install gitleaks for comprehensive secret scanning'
  });
}

// ═══════════════════════════════════════════════════════════════════════════
// 2. NEXT.JS SECURITY
// ═══════════════════════════════════════════════════════════════════════════
function auditNextConfig() {
  section('2. NEXT.JS SECURITY CONFIGURATION');
  
  const config = readFile('next.config.mjs') || '';
  
  const checks = [
    { name: 'poweredByHeader disabled', pattern: /poweredByHeader:\s*false/, severity: 'MEDIUM' as const },
    { name: 'X-Frame-Options header', pattern: /X-Frame-Options/, severity: 'HIGH' as const },
    { name: 'X-Content-Type-Options header', pattern: /X-Content-Type-Options/, severity: 'HIGH' as const },
    { name: 'Strict-Transport-Security', pattern: /Strict-Transport-Security/, severity: 'CRITICAL' as const },
    { name: 'Content-Security-Policy', pattern: /Content-Security-Policy/, severity: 'HIGH' as const },
    { name: 'Referrer-Policy', pattern: /Referrer-Policy/, severity: 'MEDIUM' as const },
    { name: 'Permissions-Policy', pattern: /Permissions-Policy/, severity: 'MEDIUM' as const },
  ];
  
  for (const check of checks) {
    log({
      category: 'NEXTJS', check: check.name,
      status: check.pattern.test(config) ? 'PASS' : 'FAIL',
      severity: check.severity,
      details: check.pattern.test(config) ? 'Configured' : 'Not found in next.config.mjs'
    });
  }
  
  // Check for dangerous settings
  if (config.includes('dangerouslyAllowSVG')) {
    log({
      category: 'NEXTJS', check: 'dangerouslyAllowSVG disabled',
      status: 'WARN', severity: 'MEDIUM',
      details: 'SVG uploads can contain XSS',
      recommendation: 'Disable in production or sanitize SVGs'
    });
  }
}

// ═══════════════════════════════════════════════════════════════════════════
// 3. DOCKER SECURITY
// ═══════════════════════════════════════════════════════════════════════════
function auditDocker() {
  section('3. DOCKER SECURITY');
  
  const dockerfile = readFile('Dockerfile') || '';
  const compose = readFile('docker-compose.yml') || '';
  
  // Dockerfile checks
  log({
    category: 'DOCKER', check: 'Multi-stage build',
    status: dockerfile.includes('AS deps') && dockerfile.includes('AS builder') ? 'PASS' : 'WARN',
    severity: 'MEDIUM',
    details: 'Reduces image size and attack surface'
  });
  
  log({
    category: 'DOCKER', check: 'Non-root user',
    status: dockerfile.includes('USER nextjs') || dockerfile.includes('USER node') ? 'PASS' : 'FAIL',
    severity: 'HIGH',
    details: dockerfile.includes('USER') ? 'Non-root user configured' : 'Running as root!',
    recommendation: 'Add USER directive with non-root user'
  });
  
  log({
    category: 'DOCKER', check: 'HEALTHCHECK defined',
    status: dockerfile.includes('HEALTHCHECK') ? 'PASS' : 'WARN',
    severity: 'LOW',
    details: 'Enables container health monitoring'
  });
  
  log({
    category: 'DOCKER', check: 'Alpine base image',
    status: dockerfile.includes('alpine') ? 'PASS' : 'INFO',
    severity: 'LOW',
    details: 'Smaller attack surface with Alpine'
  });
  
  // Docker Compose checks
  log({
    category: 'DOCKER', check: 'PostgreSQL not publicly exposed',
    status: compose.includes('127.0.0.1:5432') || !compose.includes('"5432:5432"') ? 'PASS' : 'WARN',
    severity: 'HIGH',
    details: 'DB should not be accessible externally',
    recommendation: 'Use 127.0.0.1:5432:5432 or remove port mapping'
  });
}

// ═══════════════════════════════════════════════════════════════════════════
// 4. DEPENDENCY AUDIT
// ═══════════════════════════════════════════════════════════════════════════
function auditDependencies() {
  section('4. DEPENDENCY SECURITY');
  
  const packageJson = readFile('package.json');
  if (!packageJson) {
    log({ category: 'DEPS', check: 'package.json exists', status: 'FAIL', severity: 'CRITICAL', details: 'No package.json found' });
    return;
  }
  
  const pkg = JSON.parse(packageJson);
  
  // Check for known vulnerable packages
  const vulnerablePatterns = [
    { pkg: 'lodash', minVersion: '4.17.21' },
    { pkg: 'axios', minVersion: '1.0.0' },
  ];
  
  log({
    category: 'DEPS', check: 'Prisma version',
    status: pkg.dependencies?.['@prisma/client']?.includes('7') ? 'PASS' : 'WARN',
    severity: 'MEDIUM',
    details: `Current: ${pkg.dependencies?.['@prisma/client'] || 'not found'}`
  });
  
  log({
    category: 'DEPS', check: 'Next.js version',
    status: pkg.dependencies?.next?.includes('14') ? 'PASS' : 'INFO',
    severity: 'MEDIUM',
    details: `Current: ${pkg.dependencies?.next || 'not found'}`
  });
  
  log({
    category: 'DEPS', check: 'npm audit (run manually)',
    status: 'INFO', severity: 'HIGH',
    details: 'Run: npm audit --production',
    recommendation: 'Fix vulnerabilities with npm audit fix'
  });
}

// ═══════════════════════════════════════════════════════════════════════════
// 5. AUTHENTICATION & AUTHORIZATION
// ═══════════════════════════════════════════════════════════════════════════
function auditAuth() {
  section('5. AUTHENTICATION & AUTHORIZATION');
  
  const middleware = readFile('middleware.ts') || '';
  const authConfig = readFile('lib/auth/config.ts') || '';
  
  log({
    category: 'AUTH', check: 'Middleware protection',
    status: middleware.includes('withAuth') ? 'PASS' : 'FAIL',
    severity: 'CRITICAL',
    details: middleware.includes('withAuth') ? 'NextAuth middleware active' : 'No auth middleware!'
  });
  
  log({
    category: 'AUTH', check: 'RBAC implemented',
    status: middleware.includes('Role') || middleware.includes('role') ? 'PASS' : 'WARN',
    severity: 'HIGH',
    details: 'Role-based access control'
  });
  
  log({
    category: 'AUTH', check: 'Account status check',
    status: middleware.includes('isActive') ? 'PASS' : 'WARN',
    severity: 'MEDIUM',
    details: 'Disabled accounts should be blocked'
  });
  
  // Check for secure session config
  const securityLib = readFile('lib/auth/security.ts') || '';
  log({
    category: 'AUTH', check: 'Rate limiting',
    status: securityLib.includes('rateLimit') || securityLib.includes('RateLimit') ? 'PASS' : 'WARN',
    severity: 'HIGH',
    details: 'Brute force protection'
  });
}

// ═══════════════════════════════════════════════════════════════════════════
// 6. INPUT VALIDATION
// ═══════════════════════════════════════════════════════════════════════════
function auditValidation() {
  section('6. INPUT VALIDATION & SANITIZATION');
  
  const validationLib = readFile('lib/security/validation.ts') || '';
  const sanitizeLib = readFile('lib/security/sanitize.ts') || '';
  const uploadSecurity = readFile('lib/security/upload-security.ts') || '';
  
  log({
    category: 'VALIDATION', check: 'Validation library exists',
    status: validationLib ? 'PASS' : 'WARN',
    severity: 'HIGH',
    details: validationLib ? 'lib/security/validation.ts found' : 'No validation library'
  });
  
  log({
    category: 'VALIDATION', check: 'Sanitization library exists',
    status: sanitizeLib ? 'PASS' : 'WARN',
    severity: 'HIGH',
    details: sanitizeLib ? 'lib/security/sanitize.ts found' : 'No sanitization library'
  });
  
  log({
    category: 'VALIDATION', check: 'Upload security library',
    status: uploadSecurity ? 'PASS' : 'WARN',
    severity: 'CRITICAL',
    details: uploadSecurity ? 'lib/security/upload-security.ts found' : 'No upload security'
  });
  
  // Check for Zod usage
  const packageJson = readFile('package.json') || '';
  log({
    category: 'VALIDATION', check: 'Zod validation library',
    status: packageJson.includes('zod') ? 'PASS' : 'WARN',
    severity: 'MEDIUM',
    details: 'Runtime type validation'
  });
}

// ═══════════════════════════════════════════════════════════════════════════
// 7. CI/CD SECURITY
// ═══════════════════════════════════════════════════════════════════════════
function auditCICD() {
  section('7. CI/CD SECURITY PIPELINE');
  
  const securityYml = fileExists('.github/workflows/security.yml');
  const ciYml = fileExists('.github/workflows/ci.yml');
  
  log({
    category: 'CICD', check: 'Security pipeline exists',
    status: securityYml ? 'PASS' : 'FAIL',
    severity: 'HIGH',
    details: securityYml ? '.github/workflows/security.yml found' : 'No security pipeline',
    recommendation: 'Create security scanning workflow'
  });
  
  if (securityYml) {
    const pipeline = readFile('.github/workflows/security.yml') || '';
    
    log({
      category: 'CICD', check: 'Secret scanning (gitleaks)',
      status: pipeline.includes('gitleaks') ? 'PASS' : 'WARN',
      severity: 'HIGH', details: 'Automated secret detection'
    });
    
    log({
      category: 'CICD', check: 'Dependency scanning (Snyk/npm audit)',
      status: pipeline.includes('snyk') || pipeline.includes('npm audit') ? 'PASS' : 'WARN',
      severity: 'HIGH', details: 'SCA - Software Composition Analysis'
    });
    
    log({
      category: 'CICD', check: 'SAST (CodeQL)',
      status: pipeline.includes('codeql') ? 'PASS' : 'WARN',
      severity: 'HIGH', details: 'Static Application Security Testing'
    });
    
    log({
      category: 'CICD', check: 'Container scanning (Trivy)',
      status: pipeline.includes('trivy') ? 'PASS' : 'WARN',
      severity: 'MEDIUM', details: 'Docker image vulnerability scanning'
    });
  }
}

// ═══════════════════════════════════════════════════════════════════════════
// 8. NGINX SECURITY
// ═══════════════════════════════════════════════════════════════════════════
function auditNginx() {
  section('8. NGINX/REVERSE PROXY SECURITY');
  
  const nginxConf = readFile('nginx.conf') || '';
  
  if (!nginxConf) {
    log({
      category: 'NGINX', check: 'nginx.conf exists',
      status: 'INFO', severity: 'MEDIUM',
      details: 'No nginx.conf found (may use external proxy)'
    });
    return;
  }
  
  const checks = [
    { name: 'server_tokens off', pattern: /server_tokens\s+off/, severity: 'MEDIUM' as const },
    { name: 'SSL/TLS configured', pattern: /ssl_protocols\s+TLS/, severity: 'CRITICAL' as const },
    { name: 'Rate limiting', pattern: /limit_req_zone/, severity: 'HIGH' as const },
    { name: 'Security headers', pattern: /X-Frame-Options/, severity: 'HIGH' as const },
    { name: 'HSTS enabled', pattern: /Strict-Transport-Security/, severity: 'CRITICAL' as const },
  ];
  
  for (const check of checks) {
    log({
      category: 'NGINX', check: check.name,
      status: check.pattern.test(nginxConf) ? 'PASS' : 'WARN',
      severity: check.severity,
      details: check.pattern.test(nginxConf) ? 'Configured' : 'Not found'
    });
  }
}

// ═══════════════════════════════════════════════════════════════════════════
// REPORT
// ═══════════════════════════════════════════════════════════════════════════
function generateReport() {
  section('INFRASTRUCTURE SECURITY AUDIT REPORT');
  
  const pass = results.filter(r => r.status === 'PASS').length;
  const fail = results.filter(r => r.status === 'FAIL').length;
  const warn = results.filter(r => r.status === 'WARN').length;
  const info = results.filter(r => r.status === 'INFO').length;
  
  const total = pass + fail + warn;
  const score = total > 0 ? Math.round((pass / total) * 100) : 0;
  
  console.log(`\n${C.b}Summary:${C.r}`);
  console.log(`  ${C.grn}✓ PASS:${C.r}  ${pass}`);
  console.log(`  ${C.red}✗ FAIL:${C.r}  ${fail}`);
  console.log(`  ${C.yel}⚠ WARN:${C.r}  ${warn}`);
  console.log(`  ${C.cyn}ℹ INFO:${C.r}  ${info}`);
  console.log(`\n  ${C.b}SECURITY SCORE: ${score >= 80 ? C.grn : score >= 60 ? C.yel : C.red}${score}%${C.r}`);
  
  // Critical issues
  const criticals = results.filter(r => r.status === 'FAIL' && r.severity === 'CRITICAL');
  if (criticals.length > 0) {
    console.log(`\n  ${C.red}${C.b}CRITICAL ISSUES:${C.r}`);
    criticals.forEach(c => console.log(`    → ${c.check}: ${c.details}`));
  }
  
  // High priority
  const high = results.filter(r => r.status === 'FAIL' && r.severity === 'HIGH');
  if (high.length > 0) {
    console.log(`\n  ${C.yel}${C.b}HIGH PRIORITY:${C.r}`);
    high.forEach(h => console.log(`    → ${h.check}`));
  }
  
  console.log(`\n${C.dim}Audit completed: ${new Date().toISOString()}${C.r}`);
  console.log(`${C.dim}Standards: OWASP | NIST 800-53 | CIS Benchmarks${C.r}\n`);
}

// ═══════════════════════════════════════════════════════════════════════════
// MAIN
// ═══════════════════════════════════════════════════════════════════════════
async function main() {
  console.log(`\n${C.b}${C.mag}╔${'═'.repeat(68)}╗${C.r}`);
  console.log(`${C.b}${C.mag}║  MEDACTION INFRASTRUCTURE SECURITY AUDIT                           ║${C.r}`);
  console.log(`${C.b}${C.mag}║  DevSecOps Automated Assessment Suite                              ║${C.r}`);
  console.log(`${C.b}${C.mag}╚${'═'.repeat(68)}╝${C.r}`);

  auditSecrets();
  auditNextConfig();
  auditDocker();
  auditDependencies();
  auditAuth();
  auditValidation();
  auditCICD();
  auditNginx();
  
  generateReport();
}

main().catch(console.error);
